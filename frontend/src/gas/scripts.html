<script>
 
const helpBtn = document.getElementById("helpBtn");
const helpModal = document.getElementById("helpModal");
const helpClose = document.getElementById("closeHelp");

/* ============================================================
   APPLICATION STATE (STEP 1)
============================================================ */
var appState = {
  raw: null,     // replaces lastData
  model: null
};

(function () {
  if (!/Mobi|Android/i.test(navigator.userAgent)) return;

  const box = document.createElement("pre");
  box.style.cssText = `
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    max-height:40%;
    background:#000;
    color:#0f0;
    font-size:11px;
    overflow:auto;
    padding:6px;
    z-index:9999;
  `;
  document.body.appendChild(box);

  const log = console.log;
  console.log = function (...args) {
    box.textContent += args.join(" ") + "\n";
    log.apply(console, args);
  };
})();

function isMobileViewport() {
  if (window.visualViewport) {
    return window.visualViewport.width <= 480;
  }
  return Math.min(screen.width, window.innerWidth) <= 480;
}


console.log("Viewport width:", window.innerWidth);
console.log("isMobileViewport:", isMobileViewport());

function applyResponsiveClass() {
  document.body.classList.toggle("is-mobile", isMobileViewport());
}

// Run immediately and on resize / zoom
applyResponsiveClass();
window.addEventListener("resize", applyResponsiveClass);
if (window.visualViewport) {
  window.visualViewport.addEventListener("resize", applyResponsiveClass);
}


helpBtn.addEventListener("click", () => {
  helpModal.classList.remove("hidden");
});

helpClose.addEventListener("click", () => {
  helpModal.classList.add("hidden");
});

helpModal.addEventListener("click", (e) => {
  if (e.target === helpModal) {
    helpModal.classList.add("hidden");
  }
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !helpModal.classList.contains("hidden")) {
    helpModal.classList.add("hidden");
  }
});

/* ============================================================
   METADATA / STATUS
============================================================ */
google.script.run.withSuccessHandler(meta => {
  if (!meta || !meta.version) return;

  const about = document.getElementById("aboutContent");
if (about) {
  about.innerHTML =
    `Version: v${meta.version} · ${new Date(meta.deployedAt).toLocaleString()} · ${meta.comment}`;
}

}).getAppMetadata();

function message(text) {
  document.getElementById("status").textContent = text || "";
}

/* ============================================================
   DEFAULT YEARS
============================================================ */
(function setDefaultYears() {
  var start = document.getElementById("startYear");
  var end = document.getElementById("endYear");
  var y = new Date().getFullYear();

  start.value = y;
  end.value = y + 1;

  start.addEventListener("change", function () {
    var sy = parseInt(start.value, 10);
    if (!isNaN(sy)) end.value = sy + 1;
  });
})();


/* ============================================================
   DATE FORMATTING
============================================================ */
function formatDate(iso, fmt) {
  var p = iso.split("-").map(Number);
  var y = p[0], m = p[1], d = p[2];
  var date = new Date(Date.UTC(y, m - 1, d));

  var days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  var months = ["January","February","March","April","May","June","July","August","September","October","November","December"];

  if (fmt === "slash") return String(d).padStart(2,"0") + "/" + String(m).padStart(2,"0") + "/" + y;
  if (fmt === "medium") return d + " " + months[m - 1] + " " + y;
  if (fmt === "long") return days[date.getUTCDay()] + " " + d + " " + months[m - 1] + " " + y;
  return iso;
}

/* ============================================================
   PREVIEW
============================================================ */

function regenerateIfReady() {
  var ni = document.getElementById("ni").value.trim();
  var sy = parseInt(startYear.value, 10);
  var ey = parseInt(endYear.value, 10);

  if (!ni || isNaN(sy) || isNaN(ey)) return;

  renderEmptyState("");
  appState.raw = null;
  appState.model = null;
  message("");
  
  const cycleDays = parseInt(document.getElementById("cycleDays").value, 10);

  google.script.run
  .withSuccessHandler(handlePreviewData)
  .withFailureHandler(e => message(e?.message || e))
  .generatePayments(ni, sy, ey, cycleDays);

  }

["ni","startYear","endYear", "cycleDays"].forEach(function (id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("change", regenerateIfReady);
});

function renderEmptyState(text) {
  var output = document.getElementById("outputContent");
  output.innerHTML =
    '<div class="empty-state">' +
    text +
    '</div>';
}


function updateCalendarVisibility() {
  const cal = document.querySelector(".calendar-inline");
  if (!cal) return;

  cal.classList.toggle(
    "hide-weekends",
    !document.getElementById("showWeekends").checked
  );

  cal.classList.toggle(
    "hide-bank-holidays",
    !document.getElementById("showBankHolidays").checked
  );
}

["showWeekends", "showBankHolidays"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("change", updateCalendarVisibility);
});

/* ============================================================
   List + INFO
============================================================ */
function handlePreviewData(data) {
  appState.raw = data;
  appState.model = buildCalendarModel(data, getCalendarOptions());
  appState.model.meta.eventTitle =
  document.getElementById("eventTitle")?.value || "UK State Pension";

  appState.model.meta.eventColor =
  document.getElementById("eventColor")?.value || "";

  appState.model.meta.earlyColor =
  document.getElementById("earlyColor")?.value || "";
// ---- END BLOCK ----

  renderInfoPanel(data);
  setView(currentView);
}

/* ============================================================
   CALENDAR OPTIONS
============================================================ */
function getCalendarOptions() {
  return {
    showWeekends: document.getElementById("showWeekends").checked,
    showBankHolidays: document.getElementById("showBankHolidays").checked
  };
}

/* ============================================================
   CALENDAR MODEL
============================================================ */
function buildCalendarModel(lastData, options) {
  options = options || {};
  var showWeekends = options.showWeekends !== false;
  var showBankHolidays = options.showBankHolidays !== false;

  var bankHolidays = {};
  if (showBankHolidays && lastData.bankHolidays) {
    Object.keys(lastData.bankHolidays).forEach(function (d) {
      bankHolidays[d] = lastData.bankHolidays[d];
    });
  }

  var paymentsByMonth = {};
  lastData.payments.forEach(function (p) {
  var parts = p.paid.split("-");
  var key = parts[0] + "-" + parts[1];
  var day = Number(parts[2]);
  if (!paymentsByMonth[key]) paymentsByMonth[key] = {};
  
  paymentsByMonth[key][day] = {
    early: p.early,
    holidays: p.holidays || []
  };
  
  });
  var months = [];
  var monthKeys = Object.keys(paymentsByMonth).sort();
  var holidaySymbols = ["*", "+", "#", "~", "^"];

  monthKeys.forEach(function (key) {
    var parts = key.split("-");
    var year = Number(parts[0]);
    var month = Number(parts[1]);
    var first = new Date(Date.UTC(year, month - 1, 1));
    var daysInMonth = new Date(Date.UTC(year, month, 0)).getUTCDate();
    var startOffset = (first.getUTCDay() + 6) % 7;

    var days = [];
    var paymentFootnotes = [];
    var holidayFootnotes = [];

    for (var d = 1; d <= daysInMonth; d++) {
      var iso =
        year + "-" +
        String(month).padStart(2,"0") + "-" +
        String(d).padStart(2,"0");

      var dow = (startOffset + d - 1) % 7;
      var isWeekend = dow >= 5;
      var isBH = showBankHolidays && bankHolidays[iso];
      var bhName = isBH ? bankHolidays[iso] : null;
      var pay = paymentsByMonth[key][d];

      var paymentIndex = null;
      var holidaySymbol = null;
      if (pay && pay.early) {
        paymentIndex = paymentFootnotes.length + 1;

        var note = "Paid early";
        if (pay.holidays && pay.holidays.length) {
          note += " – " + pay.holidays[0];
        } else if (isBH && bhName) {
          note += " – " + bhName;
        }

        paymentFootnotes.push(note);
      }
      
      days.push({
        day: d,
        iso: iso,
        isWeekend: isWeekend,
        isBankHoliday: !!isBH,
        isPayment: !!pay,
        paymentFootnoteIndex: paymentIndex,
        holidayFootnoteSymbol: holidaySymbol
      });
    }

    months.push({
      monthName: first.toLocaleString("en-GB", { month:"long", year:"numeric", timeZone:"UTC" }),
      startOffset: startOffset,
      days: days,
      paymentFootnotes: paymentFootnotes,
      holidayFootnotes: holidayFootnotes
    });
  });
  
  return {
    meta: {
      ni: lastData.ni,
      normalDay: lastData.normalDay,
      cycleDays: lastData.cycleDays
    },
    months: months
  };

}


function renderInfoPanel(data) {
  const panel = document.getElementById("info-panel");
  if (!panel || !data) return;

  const fmt = dateFormat.value;

  const payments = data.payments || [];
  const count = payments.length;

  if (!count) {
    panel.innerHTML =
      `<div class="info-placeholder">
        No payments fall within the selected period.
       </div>`;
    return;
  }

  const first = payments[0].paid;
  const last = payments[payments.length - 1].paid;
  const earlyCount = payments.filter(p => p.early).length;

  const cycleDays = data.cycleDays || 28;

 const cycleLabel = cycleDays === 28
    ? "Every 28 days (standard)"
    : `Every ${cycleDays} days`;

  panel.innerHTML = `
    <div>
      <strong>Payment cycle:</strong> ${cycleLabel}<br>
      <strong>Normal payment day:</strong> ${data.normalDay}<br>
      <strong>Payments shown:</strong> ${count}<br>
      <strong>Period:</strong>
        ${formatDate(first, fmt)} – ${formatDate(last, fmt)}
      ${earlyCount
        ? `<br><strong>Early payments:</strong> ${earlyCount}`
        : ``}
    </div>
  `;
}

/* ============================================================
   CALENDAR INLINE RENDER (STEP 3)
============================================================ */

function renderCalendarInline() {
  if (!appState.raw) return;

  var output = document.getElementById("outputContent");
  output.innerHTML = "";

  var options = getCalendarOptions();
  var model = buildCalendarModel(appState.raw, options);
  var monthsPerPage = isMobileViewport() ? 1 : 6;

  var out = [];

  out.push('<div class="calendar-inline">');

  for (var i = 0; i < model.months.length; i += monthsPerPage) {
    out.push('<div class="page">');

    model.months.slice(i, i + monthsPerPage).forEach(function (month) {
      out.push("<div class='month'>");
      out.push("<h3>" + month.monthName + "</h3>");
      out.push(buildCalendarLegend(options));

      out.push("<table><tr>");
      ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].forEach(function (d) {
        out.push("<th>" + d + "</th>");
      });
      out.push("</tr><tr>");

      for (var k = 0; k < month.startOffset; k++) out.push("<td></td>");

      month.days.forEach(function (day, idx) {
        var cls = [];
        if (day.isWeekend && options.showWeekends) cls.push("weekend");
        if (day.isBankHoliday && options.showBankHolidays) cls.push("bank-holiday");
        if (day.isPayment) cls.push("pay");

        out.push("<td class='" + cls.join(" ") + "'>");
        out.push(day.day);

        if (day.paymentFootnoteIndex) {
          out.push("<span class='fn'>" + day.paymentFootnoteIndex + "</span>");
        }
        if (day.holidayFootnoteSymbol) {
          out.push("<span class='fn'>" + day.holidayFootnoteSymbol + "</span>");
        }

        out.push("</td>");

        if ((idx + month.startOffset + 1) % 7 === 0) out.push("</tr><tr>");
      });

      out.push("</tr></table>");

      month.paymentFootnotes.forEach(function (t, n) {
        out.push("<div class='footnotes'><sup>" + (n + 1) + "</sup> " + t + "</div>");
      });
      month.holidayFootnotes.forEach(function (t) {
        out.push("<div class='footnotes'><sup>*</sup> " + t + "</div>");
      });

      out.push("</div>");
    });

    out.push("</div>");
  }

  out.push("</div>");
  output.innerHTML = out.join("");
}

/* ============================================================
   CALENDAR LEGEND
============================================================ */
function buildCalendarLegend(options) {
  var h = [];
  h.push('<div class="cal-legend">');
  h.push('<span class="legend-item"><span class="legend-box legend-pay"></span>Payment date</span>');
  if (options.showBankHolidays) {
    h.push('<span class="legend-item"><span class="legend-box legend-holiday"></span>Bank holiday</span>');
  }
  if (options.showWeekends) {
    h.push('<span class="legend-item"><span class="legend-box legend-weekend"></span>Weekend</span>');
  }
  h.push('</div>');
  return h.join("");
}

function renderList() {
  if (!appState.raw) return;

  const output = document.getElementById("outputContent");
  output.innerHTML = "";

  const fmt = document.getElementById("dateFormat").value;

  const ul = document.createElement("ul");
  ul.className = "date-list";

  appState.raw.payments.forEach(p => {
    let line = formatDate(p.paid, fmt);

    if (p.early) {
      const reason = p.holidays && p.holidays.length
        ? p.holidays[0]
        : "bank holiday";
      line += ` (paid early – ${reason})`;
    }

    const li = document.createElement("li");
    li.textContent = line;
    ul.appendChild(li);
  });

  output.appendChild(ul);
}


function renderCSVInline() {
  if (!appState.model) return;

  var output = document.getElementById("outputContent");
  var pre = document.createElement("pre");
  pre.textContent = buildCSVOutput(appState.model);

  output.innerHTML = "";
  output.appendChild(pre);
}

function renderICSInline() {
  if (!appState.model) return;

  var output = document.getElementById("outputContent");
  var pre = document.createElement("pre");
  pre.textContent = buildICSOutput(appState.model);

  output.innerHTML = "";
  output.appendChild(pre);
}


function printTable() {
  if (!appState.raw) return;

  var tableEl = document.querySelector("#output table");
  if (!tableEl) {
    message("Nothing to print.");
    return;
  }

  var win = window.open("", "_blank");
  if (!win) {
    message("Popup blocked. Please allow popups.");
    return;
  }

  win.document.write("<!DOCTYPE html><html><head><title>UK State Pension payments</title>");

  // reuse existing styles + minimal print tweaks
  win.document.write("<style>");
  win.document.write(document.querySelector("style").innerHTML);
  win.document.write(`
    body { background: #fff; padding: 1rem; }
    .card, .view-bar, .help-icon { display: none; }
    table { width: 100%; }
  `);
  win.document.write("</style>");

  win.document.write("</head><body>");
  win.document.write(tableEl.outerHTML);
  win.document.write("</body></html>");
  win.document.close();

  setTimeout(function () {
    win.print();
  }, 200);
}

/* ============================================================
   PRINT CALENDAR
============================================================ */
function printCalendar() {
   var CALENDAR_PRINT_CSS =
  "body{font-family:system-ui,sans-serif;padding:1rem;" +
  "-webkit-print-color-adjust:exact;print-color-adjust:exact}" +
  ".page{display:grid;grid-template-columns:1fr 1fr;gap:.9rem;" +
  "page-break-after:always}" +
  "h3{margin:.2rem 0;font-size:.9rem}" +
  "table{border-collapse:collapse;width:100%}" +
  "th,td{border:1px solid #ccc;padding:.12rem;height:2.3rem;" +
  "text-align:center;font-size:.68rem}" +
  "th{background:#f1f5f9}" +
  ".weekend{background:#f3f4f6}" +
  ".bank-holiday{background:#fee2e2}" +
  ".pay{background:#dbeafe;font-weight:700}" +
  ".fn{font-size:.55rem;vertical-align:super;font-weight:700}" +
  ".footnotes{font-size:.6rem;margin-top:.25rem;color:#92400e}" +
  ".cal-legend{display:flex;gap:1rem;align-items:center;" +
  "font-size:.8rem;color:#334155;margin:.75rem 0 1rem;flex-wrap:wrap}" +
  ".legend-item{display:inline-flex;align-items:center;gap:.35rem}" +
  ".legend-box{width:14px;height:14px;border-radius:4px;" +
  "border:1px solid #cbd5e1}" +
  ".legend-pay{background:#e0f2fe}" +
  ".legend-holiday{background:#fde2e2}" +
  ".legend-weekend{background:#f1f5f9}";
  if (!appState.raw) return;

  var win = window.open("", "_blank");
  if (!win) {
    message("Popup blocked. Please allow popups.");
    return;
  }

  win.document.write("<html><head><title>UK State Pension calendar</title>");
  win.document.write("<style>" + CALENDAR_PRINT_CSS + "</style>");
  win.document.write("</head><body>");
  win.document.write(document.querySelector(".calendar-inline").outerHTML);
  win.document.write("</body></html>");
  win.document.close();

  setTimeout(function () { win.print(); }, 200);
}

/* ============================================================
   VIEW SELECTION (STEP 2)
============================================================ */

var currentView = "calendar";

var viewTabs = document.querySelectorAll(".view-tab");
for (var i = 0; i < viewTabs.length; i++) {
  viewTabs[i].addEventListener("click", function () {
    var view = this.getAttribute("data-view");
    setView(view);
  });
}

function updateViewControls(view) {
  // Hide all view-specific controls
  document.querySelectorAll(".view-controls").forEach(el => {
    el.style.display = "none";
  });

  // Show controls for the active view
  let selector = null;

  if (view === "calendar") selector = ".view-calendar";
  if (view === "list" || view === "csv") selector = ".view-text";
  if (view === "ics") selector = ".view-ics";

  if (selector) {
    const el = document.querySelector(selector);
    if (el) el.style.display = "block";
  }
}

function setView(view) {
  currentView = view;

  document.querySelectorAll(".view-tab").forEach(tab => {
    const active = tab.dataset.view === view;
    tab.classList.toggle("active", active);
    tab.setAttribute("aria-selected", active);
  });

  updateViewControls(view);

  if (!appState.raw) {
    renderEmptyState("Enter your details to see payment dates.");
    return;
  }

  switch (view) {
    case "calendar":
      renderCalendarInline();
      break;
    case "list":
      renderList();
      break;
    case "csv":
      renderCSVInline();
      break;
    case "ics":
      renderICSInline();
      break;
  }
}



/* ============================================================
   EXPORTS
============================================================ */

document.getElementById("exportBtn").addEventListener("click", function () {
  
  if (!appState.model) {
    message("Nothing to export yet.");
    return;
  }
  switch (currentView) {
    
    case "calendar":
      printCalendar();
      break;

    case "list":
      triggerDownload(
        buildListOutput(appState.model),
        "text/plain",
        "UK-State-Pension-" + appState.model.meta.ni + ".txt"
      );
      break;

    case "csv":
      triggerDownload(
        buildCSVOutput(appState.model),
        "text/csv",
        "UK-State-Pension-" + appState.model.meta.ni + ".csv"
      );
      break;

    case "ics":
      triggerDownload(
        buildICSOutput(appState.model),
        "text/calendar",
        "UK-State-Pension-" + appState.model.meta.ni + ".ics"
      );
      break;
  }
});

function triggerDownload(content, type, name) {
  var b = new Blob([content], { type: type });
  var a = document.createElement("a");
  a.href = URL.createObjectURL(b);
  a.download = name;
  a.click();
}

function buildCSVOutput(model) {
  var csv = "Payment date,Note\n";

  model.months.forEach(function (m) {
    m.days.forEach(function (d) {
      if (!d.isPayment) return;
      var note = d.paymentFootnoteIndex
        ? m.paymentFootnotes[d.paymentFootnoteIndex - 1]
        : "";
      csv += d.iso + ',"' + note.replace(/"/g, '""') + '"\n';
    });
  });

  return csv;
}

function buildICSOutput(model) {
  const lines = [];
  const cycleDays = model.meta.cycleDays || 28;
  const title = escapeICS(model.meta.eventTitle || "UK State Pension");
  const color = model.meta.eventColor;
  const earlyColor = model.meta.earlyColor || color;

  

  lines.push("BEGIN:VCALENDAR");
  lines.push("VERSION:2.0");
  lines.push("PRODID:-//UK State Pension Calendar//EN");

  const normalDates = [];
  const earlyPayments = [];

  model.months.forEach(m => {
    m.days.forEach(d => {
      if (!d.isPayment) return;

      if (d.paymentFootnoteIndex) {
        earlyPayments.push({
          paid: d.iso,
          note: m.paymentFootnotes[d.paymentFootnoteIndex - 1] || ""
        });
      } else {
        normalDates.push(d.iso);
      }
    });
  });

  if (!normalDates.length) {
    lines.push("END:VCALENDAR");
    return lines.join("\n");
  }

  /* ---- Recurring event ---- */

  lines.push("BEGIN:VEVENT");
  lines.push("UID:uksp-recurring@" + location.hostname);
  lines.push("DTSTART;VALUE=DATE:" + normalDates[0].replace(/-/g, ""));
  lines.push("RRULE:FREQ=DAILY;INTERVAL=" + cycleDays);
  lines.push("SUMMARY:" + title);
  lines.push("CATEGORIES:Pension");

  if (color) {
    lines.push("X-APPLE-CALENDAR-COLOR:" + color);
  }

  earlyPayments.forEach(p => {
    lines.push("EXDATE;VALUE=DATE:" + p.paid.replace(/-/g, ""));
  });

  lines.push("END:VEVENT");

  /* ---- Early payment overrides ---- */

  earlyPayments.forEach(p => {
    lines.push("BEGIN:VEVENT");
    lines.push(
      "UID:uksp-early-" + p.paid.replace(/-/g, "") + "@" + location.hostname
    );
    lines.push("DTSTART;VALUE=DATE:" + p.paid.replace(/-/g, ""));
    lines.push("SUMMARY:" + title + " (paid early)");
    lines.push("DESCRIPTION:" + escapeICS(p.note));
    lines.push("CATEGORIES:Pension");

    if (earlyColor) {
      lines.push("X-APPLE-CALENDAR-COLOR:" + earlyColor);
    }

    lines.push("END:VEVENT");
  });

  lines.push("END:VCALENDAR");
  return lines.join("\n");
}

/* ---- ICS text escaping ---- */
function escapeICS(text) {
  return String(text || "")
    .replace(/\\/g, "\\\\")
    .replace(/;/g, "\\;")
    .replace(/,/g, "\\,")
    .replace(/\n/g, "\\n");
}


/* ============================================================
   AUTO PREVIEW ON CHANGE
============================================================ */
["startYear","endYear","dateFormat"].forEach(function (id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.addEventListener("change", function () {
    if (appState.raw) setView(currentView);
  });
});

setView(currentView);
</script>