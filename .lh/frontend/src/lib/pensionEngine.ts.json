{
    "sourceFile": "frontend/src/lib/pensionEngine.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 33,
            "patches": [
                {
                    "date": 1768745725760,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1768745864846,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,20 +10,59 @@\n   ni: string;\r\n   normalDay: string;\r\n   cycleDays: number;\r\n   payments: Payment[];\r\n-  bankHolidays?: Record<string, string>;\r\n };\r\n \r\n+/* ------------------------------------------------------------\r\n+   Helpers\r\n+------------------------------------------------------------ */\r\n+\r\n+function addDaysUTC(date: Date, days: number): Date {\r\n+  const d = new Date(date);\r\n+  d.setUTCDate(d.getUTCDate() + days);\r\n+  return d;\r\n+}\r\n+\r\n+function formatISO(date: Date): string {\r\n+  return date.toISOString().slice(0, 10);\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   MAIN ENGINE\r\n+------------------------------------------------------------ */\r\n+\r\n export function generatePayments(\r\n   ni: string,\r\n   startYear: number,\r\n   endYear: number,\r\n-  cycleDays: number\r\n+  cycleDays: number = 28\r\n ): PensionResult {\r\n+\r\n+  // ⚠️ TEMP BASE DATE (we'll improve later)\r\n+  const BASE_DATE = new Date(Date.UTC(2024, 0, 2)); // Tuesday\r\n+\r\n+  let d = new Date(BASE_DATE);\r\n+\r\n+  const payments: Payment[] = [];\r\n+\r\n+  // Fast-forward to startYear\r\n+  while (d.getUTCFullYear() < startYear) {\r\n+    d = addDaysUTC(d, cycleDays);\r\n+  }\r\n+\r\n+  while (d.getUTCFullYear() <= endYear) {\r\n+    payments.push({\r\n+      paid: formatISO(d),\r\n+      early: false\r\n+    });\r\n+\r\n+    d = addDaysUTC(d, cycleDays);\r\n+  }\r\n+\r\n   return {\r\n     ni,\r\n     normalDay: 'Tuesday',\r\n     cycleDays,\r\n-    payments: []\r\n+    payments\r\n   };\r\n }\r\n"
                },
                {
                    "date": 1768745995360,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -26,8 +26,28 @@\n function formatISO(date: Date): string {\r\n   return date.toISOString().slice(0, 10);\r\n }\r\n \r\n+function getPaymentWeekdayFromNI(ni: string): {\r\n+  weekdayIndex: number;\r\n+  weekdayName: string;\r\n+} {\r\n+  const match = ni.match(/(\\d{2})$/);\r\n+  if (!match) {\r\n+    // Safe default\r\n+    return { weekdayIndex: 1, weekdayName: \"Tuesday\" };\r\n+  }\r\n+\r\n+  const n = parseInt(match[1], 10);\r\n+\r\n+  if (n <= 19) return { weekdayIndex: 1, weekdayName: \"Monday\" };\r\n+  if (n <= 39) return { weekdayIndex: 2, weekdayName: \"Tuesday\" };\r\n+  if (n <= 59) return { weekdayIndex: 3, weekdayName: \"Wednesday\" };\r\n+  if (n <= 79) return { weekdayIndex: 4, weekdayName: \"Thursday\" };\r\n+  return { weekdayIndex: 5, weekdayName: \"Friday\" };\r\n+}\r\n+\r\n+\r\n /* ------------------------------------------------------------\r\n    MAIN ENGINE\r\n ------------------------------------------------------------ */\r\n \r\n"
                },
                {
                    "date": 1768746202476,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -57,13 +57,18 @@\n   endYear: number,\r\n   cycleDays: number = 28\r\n ): PensionResult {\r\n \r\n-  // ⚠️ TEMP BASE DATE (we'll improve later)\r\n-  const BASE_DATE = new Date(Date.UTC(2024, 0, 2)); // Tuesday\r\n+  const { weekdayIndex, weekdayName } = getPaymentWeekdayFromNI(ni);\r\n \r\n-  let d = new Date(BASE_DATE);\r\n+// Known reference: 2024-01-01 was a Monday\r\n+let d = new Date(Date.UTC(2024, 0, 1));\r\n \r\n+// Move forward until weekday matches NI rule\r\n+while (d.getUTCDay() !== (weekdayIndex % 7)) {\r\n+d = addDaysUTC(d, 1);\r\n+}\r\n+\r\n   const payments: Payment[] = [];\r\n \r\n   // Fast-forward to startYear\r\n   while (d.getUTCFullYear() < startYear) {\r\n"
                },
                {
                    "date": 1768746216691,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,9 +85,9 @@\n   }\r\n \r\n   return {\r\n     ni,\r\n-    normalDay: 'Tuesday',\r\n+    normalDay: 'weekdayName',\r\n     cycleDays,\r\n     payments\r\n   };\r\n }\r\n"
                },
                {
                    "date": 1768746269758,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,9 +85,9 @@\n   }\r\n \r\n   return {\r\n     ni,\r\n-    normalDay: 'weekdayName',\r\n+    normalDay: weekdayName,\r\n     cycleDays,\r\n     payments\r\n   };\r\n }\r\n"
                },
                {
                    "date": 1768746471117,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -27,24 +27,25 @@\n   return date.toISOString().slice(0, 10);\r\n }\r\n \r\n function getPaymentWeekdayFromNI(ni: string): {\r\n-  weekdayIndex: number;\r\n+  jsWeekday: number;\r\n   weekdayName: string;\r\n } {\r\n   const match = ni.match(/(\\d{2})$/);\r\n+\r\n+  // Default: Tuesday (safe fallback)\r\n   if (!match) {\r\n-    // Safe default\r\n-    return { weekdayIndex: 1, weekdayName: \"Tuesday\" };\r\n+    return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n   }\r\n \r\n   const n = parseInt(match[1], 10);\r\n \r\n-  if (n <= 19) return { weekdayIndex: 1, weekdayName: \"Monday\" };\r\n-  if (n <= 39) return { weekdayIndex: 2, weekdayName: \"Tuesday\" };\r\n-  if (n <= 59) return { weekdayIndex: 3, weekdayName: \"Wednesday\" };\r\n-  if (n <= 79) return { weekdayIndex: 4, weekdayName: \"Thursday\" };\r\n-  return { weekdayIndex: 5, weekdayName: \"Friday\" };\r\n+  if (n <= 19) return { jsWeekday: 1, weekdayName: \"Monday\" };\r\n+  if (n <= 39) return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n+  if (n <= 59) return { jsWeekday: 3, weekdayName: \"Wednesday\" };\r\n+  if (n <= 79) return { jsWeekday: 4, weekdayName: \"Thursday\" };\r\n+  return { jsWeekday: 5, weekdayName: \"Friday\" };\r\n }\r\n \r\n \r\n /* ------------------------------------------------------------\r\n"
                },
                {
                    "date": 1768747942390,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -58,9 +58,9 @@\n   endYear: number,\r\n   cycleDays: number = 28\r\n ): PensionResult {\r\n \r\n-  const { weekdayIndex, weekdayName } = getPaymentWeekdayFromNI(ni);\r\n+  const { jsWeekday, weekdayName } = getPaymentWeekdayFromNI(ni);\r\n \r\n // Known reference: 2024-01-01 was a Monday\r\n let d = new Date(Date.UTC(2024, 0, 1));\r\n \r\n"
                },
                {
                    "date": 1768748174482,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,9 +64,9 @@\n // Known reference: 2024-01-01 was a Monday\r\n let d = new Date(Date.UTC(2024, 0, 1));\r\n \r\n // Move forward until weekday matches NI rule\r\n-while (d.getUTCDay() !== (weekdayIndex % 7)) {\r\n+while (d.getUTCDay() !== (jsWeekday % 7)) {\r\n d = addDaysUTC(d, 1);\r\n }\r\n \r\n   const payments: Payment[] = [];\r\n"
                },
                {
                    "date": 1768748514236,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -46,9 +46,8 @@\n   if (n <= 79) return { jsWeekday: 4, weekdayName: \"Thursday\" };\r\n   return { jsWeekday: 5, weekdayName: \"Friday\" };\r\n }\r\n \r\n-\r\n /* ------------------------------------------------------------\r\n    MAIN ENGINE\r\n ------------------------------------------------------------ */\r\n \r\n"
                },
                {
                    "date": 1768748798918,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,93 +1,95 @@\n // src/lib/pensionEngine.ts\r\n \r\n export type Payment = {\r\n-  paid: string;        // YYYY-MM-DD\r\n-  early: boolean;\r\n-  holidays?: string[];\r\n+    paid: string;        // YYYY-MM-DD\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n };\r\n \r\n export type PensionResult = {\r\n-  ni: string;\r\n-  normalDay: string;\r\n-  cycleDays: number;\r\n-  payments: Payment[];\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n };\r\n \r\n /* ------------------------------------------------------------\r\n    Helpers\r\n ------------------------------------------------------------ */\r\n \r\n function addDaysUTC(date: Date, days: number): Date {\r\n-  const d = new Date(date);\r\n-  d.setUTCDate(d.getUTCDate() + days);\r\n-  return d;\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n }\r\n \r\n function formatISO(date: Date): string {\r\n-  return date.toISOString().slice(0, 10);\r\n+    return date.toISOString().slice(0, 10);\r\n }\r\n \r\n function getPaymentWeekdayFromNI(ni: string): {\r\n-  jsWeekday: number;\r\n-  weekdayName: string;\r\n+    jsWeekday: number;\r\n+    weekdayName: string;\r\n } {\r\n-  const match = ni.match(/(\\d{2})$/);\r\n+    const match = ni.match(/(\\d{2})$/);\r\n \r\n-  // Default: Tuesday (safe fallback)\r\n-  if (!match) {\r\n-    return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n-  }\r\n+    // Default: Tuesday (safe fallback)\r\n+    if (!match) {\r\n+        return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n+    }\r\n \r\n-  const n = parseInt(match[1], 10);\r\n+    const n = parseInt(match[1], 10);\r\n \r\n-  if (n <= 19) return { jsWeekday: 1, weekdayName: \"Monday\" };\r\n-  if (n <= 39) return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n-  if (n <= 59) return { jsWeekday: 3, weekdayName: \"Wednesday\" };\r\n-  if (n <= 79) return { jsWeekday: 4, weekdayName: \"Thursday\" };\r\n-  return { jsWeekday: 5, weekdayName: \"Friday\" };\r\n+    if (n <= 19) return { jsWeekday: 1, weekdayName: \"Monday\" };\r\n+    if (n <= 39) return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n+    if (n <= 59) return { jsWeekday: 3, weekdayName: \"Wednesday\" };\r\n+    if (n <= 79) return { jsWeekday: 4, weekdayName: \"Thursday\" };\r\n+    return { jsWeekday: 5, weekdayName: \"Friday\" };\r\n }\r\n \r\n /* ------------------------------------------------------------\r\n    MAIN ENGINE\r\n ------------------------------------------------------------ */\r\n \r\n export function generatePayments(\r\n-  ni: string,\r\n-  startYear: number,\r\n-  endYear: number,\r\n-  cycleDays: number = 28\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28\r\n ): PensionResult {\r\n \r\n-  const { jsWeekday, weekdayName } = getPaymentWeekdayFromNI(ni);\r\n \r\n-// Known reference: 2024-01-01 was a Monday\r\n-let d = new Date(Date.UTC(2024, 0, 1));\r\n \r\n-// Move forward until weekday matches NI rule\r\n-while (d.getUTCDay() !== (jsWeekday % 7)) {\r\n-d = addDaysUTC(d, 1);\r\n-}\r\n+    const payments: Payment[] = [];\r\n \r\n-  const payments: Payment[] = [];\r\n+    const { jsWeekday, weekdayName } = getPaymentWeekdayFromNI(ni);\r\n \r\n-  // Fast-forward to startYear\r\n-  while (d.getUTCFullYear() < startYear) {\r\n-    d = addDaysUTC(d, cycleDays);\r\n-  }\r\n+    // 2024-01-01 was a Monday\r\n+    let d = new Date(Date.UTC(2024, 0, 1));\r\n \r\n-  while (d.getUTCFullYear() <= endYear) {\r\n-    payments.push({\r\n-      paid: formatISO(d),\r\n-      early: false\r\n-    });\r\n+    // Move forward until weekday matches NI rule\r\n+    while (d.getUTCDay() !== jsWeekday) {\r\n+        d = addDaysUTC(d, 1);\r\n+    }\r\n \r\n-    d = addDaysUTC(d, cycleDays);\r\n-  }\r\n+    // Fast-forward to startYear\r\n+    while (d.getUTCFullYear() < startYear) {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n \r\n-  return {\r\n-    ni,\r\n-    normalDay: weekdayName,\r\n-    cycleDays,\r\n-    payments\r\n-  };\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        payments.push({\r\n+            paid: formatISO(d),\r\n+            early: false\r\n+        });\r\n+\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    return {\r\n+        ni,\r\n+        normalDay: weekdayName,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n }\r\n"
                },
                {
                    "date": 1768748989754,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,10 +30,10 @@\n function getPaymentWeekdayFromNI(ni: string): {\r\n     jsWeekday: number;\r\n     weekdayName: string;\r\n } {\r\n-    const match = ni.match(/(\\d{2})$/);\r\n-\r\n+    const match = ni.match(/(\\d{2})[A-D]$/i);\r\n+    \r\n     // Default: Tuesday (safe fallback)\r\n     if (!match) {\r\n         return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n     }\r\n"
                },
                {
                    "date": 1768749056455,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -26,14 +26,15 @@\n function formatISO(date: Date): string {\r\n     return date.toISOString().slice(0, 10);\r\n }\r\n \r\n+\r\n function getPaymentWeekdayFromNI(ni: string): {\r\n     jsWeekday: number;\r\n     weekdayName: string;\r\n } {\r\n     const match = ni.match(/(\\d{2})[A-D]$/i);\r\n-    \r\n+\r\n     // Default: Tuesday (safe fallback)\r\n     if (!match) {\r\n         return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n     }\r\n"
                },
                {
                    "date": 1768749181838,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,12 +33,16 @@\n     weekdayName: string;\r\n } {\r\n     const match = ni.match(/(\\d{2})[A-D]$/i);\r\n \r\n-    // Default: Tuesday (safe fallback)\r\n+    // // Default: Tuesday (safe fallback)\r\n+    // if (!match) {\r\n+    //     return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n+    // }\r\n+\r\n     if (!match) {\r\n-        return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n-    }\r\n+    throw new Error(\"NI parsing failed: \" + ni);\r\n+}\r\n \r\n     const n = parseInt(match[1], 10);\r\n \r\n     if (n <= 19) return { jsWeekday: 1, weekdayName: \"Monday\" };\r\n"
                },
                {
                    "date": 1768749270359,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -31,8 +31,10 @@\n function getPaymentWeekdayFromNI(ni: string): {\r\n     jsWeekday: number;\r\n     weekdayName: string;\r\n } {\r\n+    ni = ni.trim().toUpperCase();\r\n+\r\n     const match = ni.match(/(\\d{2})[A-D]$/i);\r\n \r\n     // // Default: Tuesday (safe fallback)\r\n     // if (!match) {\r\n"
                },
                {
                    "date": 1768749298530,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,9 +33,9 @@\n     weekdayName: string;\r\n } {\r\n     ni = ni.trim().toUpperCase();\r\n \r\n-    const match = ni.match(/(\\d{2})[A-D]$/i);\r\n+    const match = ni.match(/(\\d{2})[A-D]$/);\r\n \r\n     // // Default: Tuesday (safe fallback)\r\n     // if (!match) {\r\n     //     return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n"
                },
                {
                    "date": 1768749389078,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,16 +35,11 @@\n     ni = ni.trim().toUpperCase();\r\n \r\n     const match = ni.match(/(\\d{2})[A-D]$/);\r\n \r\n-    // // Default: Tuesday (safe fallback)\r\n-    // if (!match) {\r\n-    //     return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n-    // }\r\n-\r\n     if (!match) {\r\n-    throw new Error(\"NI parsing failed: \" + ni);\r\n-}\r\n+        throw new Error(\"NI parsing failed: \" + ni);\r\n+    }\r\n \r\n     const n = parseInt(match[1], 10);\r\n \r\n     if (n <= 19) return { jsWeekday: 1, weekdayName: \"Monday\" };\r\n@@ -53,8 +48,9 @@\n     if (n <= 79) return { jsWeekday: 4, weekdayName: \"Thursday\" };\r\n     return { jsWeekday: 5, weekdayName: \"Friday\" };\r\n }\r\n \r\n+\r\n /* ------------------------------------------------------------\r\n    MAIN ENGINE\r\n ------------------------------------------------------------ */\r\n \r\n"
                },
                {
                    "date": 1768751030394,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,135 @@\n+// src/lib/pensionEngine.ts\r\n+\r\n+export type Payment = {\r\n+    paid: string;        // YYYY-MM-DD (UTC)\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n+};\r\n+\r\n+export type PensionResult = {\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n+};\r\n+\r\n+/* ------------------------------------------------------------\r\n+   CONSTANTS\r\n+------------------------------------------------------------ */\r\n+\r\n+// Confirmed real DWP anchor:\r\n+// NI 29B was paid on Tuesday 6 Jan 2026\r\n+const BASE_DATE = new Date(Date.UTC(2026, 0, 6)); // 2026-01-06 (Tuesday)\r\n+const BASE_NI = \"29B\";\r\n+\r\n+/* ------------------------------------------------------------\r\n+   DATE HELPERS (UTC SAFE)\r\n+------------------------------------------------------------ */\r\n+\r\n+function addDaysUTC(date: Date, days: number): Date {\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n+}\r\n+\r\n+function formatISO(date: Date): string {\r\n+    return date.toISOString().slice(0, 10);\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   NI OFFSET LOGIC (RELATIVE TO BASE_NI)\r\n+------------------------------------------------------------ */\r\n+\r\n+function parseNI(ni: string): { digits: number; letter: string } {\r\n+    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+    if (!m) {\r\n+        throw new Error(`NI parsing failed: ${ni}`);\r\n+    }\r\n+    return {\r\n+        digits: parseInt(m[1], 10),\r\n+        letter: m[2]\r\n+    };\r\n+}\r\n+\r\n+/**\r\n+ * Returns the day-offset (multiple of 7) between BASE_NI and target NI\r\n+ * This preserves the national DWP payment grid.\r\n+ */\r\n+function niOffsetDays(ni: string): number {\r\n+    const base = parseNI(BASE_NI);\r\n+    const target = parseNI(ni);\r\n+\r\n+    // Letter offset (columns): A–D = 0–3 weeks\r\n+    const letterOffset =\r\n+        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+\r\n+    // Digit offset (rows)\r\n+    function row(d: number): number {\r\n+        if (d <= 19) return 0;\r\n+        if (d <= 39) return 1;\r\n+        if (d <= 59) return 2;\r\n+        if (d <= 79) return 3;\r\n+        return 4;\r\n+    }\r\n+\r\n+    const digitOffset =\r\n+        (row(target.digits) - row(base.digits)) * 7;\r\n+\r\n+    return letterOffset + digitOffset;\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   MAIN ENGINE\r\n+------------------------------------------------------------ */\r\n+\r\n+export function generatePayments(\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28\r\n+): PensionResult {\r\n+\r\n+    if (![7, 14, 28].includes(cycleDays)) {\r\n+        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+    }\r\n+\r\n+    const offsetDays = niOffsetDays(ni);\r\n+\r\n+    // Anchor this NI to the real DWP grid\r\n+    let d = addDaysUTC(BASE_DATE, offsetDays);\r\n+\r\n+    const payments: Payment[] = [];\r\n+\r\n+    // Rewind if anchor is after requested range\r\n+    while (d.getUTCFullYear() > endYear) {\r\n+        d = addDaysUTC(d, -cycleDays);\r\n+    }\r\n+\r\n+    // Fast-forward into range\r\n+    while (d.getUTCFullYear() < startYear) {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    // Collect payments\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        payments.push({\r\n+            paid: formatISO(d),\r\n+            early: false\r\n+        });\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    const weekdayName = new Date(\r\n+        Date.UTC(2026, 0, 6)\r\n+    ).toLocaleDateString(\"en-GB\", {\r\n+        weekday: \"long\",\r\n+        timeZone: \"UTC\"\r\n+    });\r\n+\r\n+    return {\r\n+        ni,\r\n+        normalDay: weekdayName,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n+}\r\n"
                },
                {
                    "date": 1768751388974,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,122 @@\n+// src/lib/pensionEngine.ts\r\n+\r\n+export type Payment = {\r\n+    paid: string;        // YYYY-MM-DD (UTC)\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n+};\r\n+\r\n+export type PensionResult = {\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n+};\r\n+\r\n+/* ------------------------------------------------------------\r\n+   VERIFIED DWP ANCHOR\r\n+------------------------------------------------------------ */\r\n+\r\n+// Confirmed real payment:\r\n+// NI 29B → Tuesday 6 January 2026\r\n+const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n+const BASE_NI = \"29B\";\r\n+\r\n+/* ------------------------------------------------------------\r\n+   DATE HELPERS (UTC SAFE)\r\n+------------------------------------------------------------ */\r\n+\r\n+function addDaysUTC(date: Date, days: number): Date {\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n+}\r\n+\r\n+function formatISO(date: Date): string {\r\n+    return date.toISOString().slice(0, 10);\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n+------------------------------------------------------------ */\r\n+\r\n+function parseNI(ni: string): { digits: number; letter: string } {\r\n+    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+    return { digits: +m[1], letter: m[2] };\r\n+}\r\n+\r\n+function rowFromDigits(d: number): number {\r\n+    if (d <= 19) return 0;\r\n+    if (d <= 39) return 1;\r\n+    if (d <= 59) return 2;\r\n+    if (d <= 79) return 3;\r\n+    return 4;\r\n+}\r\n+\r\n+function niOffsetDays(ni: string): number {\r\n+    const base = parseNI(BASE_NI);\r\n+    const target = parseNI(ni);\r\n+\r\n+    const rowOffset =\r\n+        (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n+\r\n+    const colOffset =\r\n+        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+\r\n+    return rowOffset + colOffset;\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   MAIN ENGINE\r\n+------------------------------------------------------------ */\r\n+\r\n+export function generatePayments(\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28\r\n+): PensionResult {\r\n+\r\n+    if (![7, 14, 28].includes(cycleDays)) {\r\n+        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+    }\r\n+\r\n+    // 1️⃣ Anchor this NI to the real DWP grid\r\n+    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+\r\n+    // 2️⃣ Rewind far enough to cover requested range\r\n+    while (d.getUTCFullYear() > startYear) {\r\n+        d = addDaysUTC(d, -cycleDays);\r\n+    }\r\n+\r\n+    // 3️⃣ Move forward into range\r\n+    while (d.getUTCFullYear() < startYear) {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    const payments: Payment[] = [];\r\n+\r\n+    // 4️⃣ Collect payments\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        payments.push({\r\n+            paid: formatISO(d),\r\n+            early: false\r\n+        });\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n+    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+        .toLocaleDateString(\"en-GB\", {\r\n+            weekday: \"long\",\r\n+            timeZone: \"UTC\"\r\n+        });\r\n+\r\n+    return {\r\n+        ni,\r\n+        normalDay,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n+}\r\n"
                },
                {
                    "date": 1768751861284,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,141 @@\n+// src/lib/pensionEngine.ts\r\n+\r\n+export type Payment = {\r\n+    paid: string;        // YYYY-MM-DD (UTC)\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n+};\r\n+\r\n+export type PensionResult = {\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n+};\r\n+\r\n+/* ------------------------------------------------------------\r\n+   VERIFIED DWP ANCHOR\r\n+------------------------------------------------------------ */\r\n+\r\n+// Confirmed real payment:\r\n+// NI 29B → Tuesday 6 January 2026\r\n+const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n+const BASE_NI = \"29B\";\r\n+\r\n+/* ------------------------------------------------------------\r\n+   DATE HELPERS (UTC SAFE)\r\n+------------------------------------------------------------ */\r\n+\r\n+function addDaysUTC(date: Date, days: number): Date {\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n+}\r\n+\r\n+function formatISO(date: Date): string {\r\n+    return date.toISOString().slice(0, 10);\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n+------------------------------------------------------------ */\r\n+\r\n+function parseNI(ni: string): { digits: number; letter: string } {\r\n+    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+    return { digits: +m[1], letter: m[2] };\r\n+}\r\n+\r\n+function rowFromDigits(d: number): number {\r\n+    if (d <= 19) return 0;\r\n+    if (d <= 39) return 1;\r\n+    if (d <= 59) return 2;\r\n+    if (d <= 79) return 3;\r\n+    return 4;\r\n+}\r\n+\r\n+function niOffsetDays(ni: string): number {\r\n+    const base = parseNI(BASE_NI);\r\n+    const target = parseNI(ni);\r\n+\r\n+    const rowOffset =\r\n+        (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n+\r\n+    const colOffset =\r\n+        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+\r\n+    return rowOffset + colOffset;\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   MAIN ENGINE\r\n+------------------------------------------------------------ */\r\n+\r\n+function getPaymentWeekdayFromNI(ni: string): {\r\n+    jsWeekday: number;\r\n+    weekdayName: string;\r\n+} {\r\n+    const match = ni.toUpperCase().match(/(\\d{2})[A-Z]?$/);\r\n+\r\n+    if (!match) {\r\n+        throw new Error(`NI parsing failed: ${ni}`);\r\n+    }\r\n+\r\n+    const n = parseInt(match[1], 10);\r\n+\r\n+    if (n <= 19) return { jsWeekday: 1, weekdayName: \"Monday\" };\r\n+    if (n <= 39) return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n+    if (n <= 59) return { jsWeekday: 3, weekdayName: \"Wednesday\" };\r\n+    if (n <= 79) return { jsWeekday: 4, weekdayName: \"Thursday\" };\r\n+    return { jsWeekday: 5, weekdayName: \"Friday\" };\r\n+}\r\n+\r\n+export function generatePayments(\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28\r\n+): PensionResult {\r\n+\r\n+    if (![7, 14, 28].includes(cycleDays)) {\r\n+        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+    }\r\n+\r\n+    // 1️⃣ Anchor this NI to the real DWP grid\r\n+    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+\r\n+    // 2️⃣ Rewind far enough to cover requested range\r\n+    while (d.getUTCFullYear() > startYear) {\r\n+        d = addDaysUTC(d, -cycleDays);\r\n+    }\r\n+\r\n+    // 3️⃣ Move forward into range\r\n+    while (d.getUTCFullYear() < startYear) {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    const payments: Payment[] = [];\r\n+\r\n+    // 4️⃣ Collect payments\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        payments.push({\r\n+            paid: formatISO(d),\r\n+            early: false\r\n+        });\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n+    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+        .toLocaleDateString(\"en-GB\", {\r\n+            weekday: \"long\",\r\n+            timeZone: \"UTC\"\r\n+        });\r\n+\r\n+    return {\r\n+        ni,\r\n+        normalDay,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n+}\r\n"
                },
                {
                    "date": 1768752234090,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,123 @@\n+// src/lib/pensionEngine.ts\r\n+\r\n+export type Payment = {\r\n+    paid: string;        // YYYY-MM-DD (UTC)\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n+};\r\n+\r\n+export type PensionResult = {\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n+};\r\n+\r\n+/* ------------------------------------------------------------\r\n+   VERIFIED DWP ANCHOR\r\n+------------------------------------------------------------ */\r\n+\r\n+// Confirmed real payment:\r\n+// NI 29B → Tuesday 6 January 2026\r\n+const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n+const BASE_NI = \"29B\";\r\n+\r\n+/* ------------------------------------------------------------\r\n+   DATE HELPERS (UTC SAFE)\r\n+------------------------------------------------------------ */\r\n+\r\n+function addDaysUTC(date: Date, days: number): Date {\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n+}\r\n+\r\n+function formatISO(date: Date): string {\r\n+    return date.toISOString().slice(0, 10);\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n+------------------------------------------------------------ */\r\n+\r\n+function parseNI(ni: string): { digits: number; letter: string } {\r\n+    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+    return { digits: +m[1], letter: m[2] };\r\n+}\r\n+\r\n+function rowFromDigits(d: number): number {\r\n+    if (d <= 19) return 0;\r\n+    if (d <= 39) return 1;\r\n+    if (d <= 59) return 2;\r\n+    if (d <= 79) return 3;\r\n+    return 4;\r\n+}\r\n+\r\n+function niOffsetDays(ni: string): number {\r\n+    const base = parseNI(BASE_NI);\r\n+    const target = parseNI(ni);\r\n+\r\n+    const rowOffset =\r\n+        (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n+\r\n+    const colOffset =\r\n+        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+\r\n+    return rowOffset + colOffset;\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   MAIN ENGINE\r\n+------------------------------------------------------------ */\r\n+\r\n+\r\n+export function generatePayments(\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28\r\n+): PensionResult {\r\n+\r\n+    if (![7, 14, 28].includes(cycleDays)) {\r\n+        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+    }\r\n+\r\n+    // 1️⃣ Anchor this NI to the real DWP grid\r\n+    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+\r\n+    // 2️⃣ Rewind far enough to cover requested range\r\n+    while (d.getUTCFullYear() > startYear) {\r\n+        d = addDaysUTC(d, -cycleDays);\r\n+    }\r\n+\r\n+    // 3️⃣ Move forward into range\r\n+    while (d.getUTCFullYear() < startYear) {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    const payments: Payment[] = [];\r\n+\r\n+    // 4️⃣ Collect payments\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        payments.push({\r\n+            paid: formatISO(d),\r\n+            early: false\r\n+        });\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n+    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+        .toLocaleDateString(\"en-GB\", {\r\n+            weekday: \"long\",\r\n+            timeZone: \"UTC\"\r\n+        });\r\n+\r\n+    return {\r\n+        ni,\r\n+        normalDay,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n+}\r\n"
                },
                {
                    "date": 1768752703000,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,118 @@\n+// src/lib/pensionEngine.ts\r\n+\r\n+export type Payment = {\r\n+    paid: string;        // YYYY-MM-DD (UTC)\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n+};\r\n+\r\n+export type PensionResult = {\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n+};\r\n+\r\n+// VERIFIED DWP GRID ANCHOR\r\n+const BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\n+const BASE_NI = \"00A\";\r\n+\r\n+/* ------------------------------------------------------------\r\n+   DATE HELPERS (UTC SAFE)\r\n+------------------------------------------------------------ */\r\n+\r\n+function addDaysUTC(date: Date, days: number): Date {\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n+}\r\n+\r\n+function formatISO(date: Date): string {\r\n+    return date.toISOString().slice(0, 10);\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n+------------------------------------------------------------ */\r\n+\r\n+function parseNI(ni: string): { digits: number; letter: string } {\r\n+    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+    return { digits: +m[1], letter: m[2] };\r\n+}\r\n+\r\n+function rowFromDigits(d: number): number {\r\n+    if (d <= 19) return 0;\r\n+    if (d <= 39) return 1;\r\n+    if (d <= 59) return 2;\r\n+    if (d <= 79) return 3;\r\n+    return 4;\r\n+}\r\n+\r\n+function niOffsetDays(ni: string): number {\r\n+    const base = parseNI(BASE_NI);\r\n+    const target = parseNI(ni);\r\n+\r\n+    const rowOffset =\r\n+        (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n+\r\n+    const colOffset =\r\n+        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+\r\n+    return rowOffset + colOffset;\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   MAIN ENGINE\r\n+------------------------------------------------------------ */\r\n+\r\n+\r\n+export function generatePayments(\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28\r\n+): PensionResult {\r\n+\r\n+    if (![7, 14, 28].includes(cycleDays)) {\r\n+        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+    }\r\n+\r\n+    // 1️⃣ Anchor this NI to the real DWP grid\r\n+    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+\r\n+    // 2️⃣ Rewind far enough to cover requested range\r\n+    while (d.getUTCFullYear() > startYear) {\r\n+        d = addDaysUTC(d, -cycleDays);\r\n+    }\r\n+\r\n+    // 3️⃣ Move forward into range\r\n+    while (d.getUTCFullYear() < startYear) {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    const payments: Payment[] = [];\r\n+\r\n+    // 4️⃣ Collect payments\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        payments.push({\r\n+            paid: formatISO(d),\r\n+            early: false\r\n+        });\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n+    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+        .toLocaleDateString(\"en-GB\", {\r\n+            weekday: \"long\",\r\n+            timeZone: \"UTC\"\r\n+        });\r\n+\r\n+    return {\r\n+        ni,\r\n+        normalDay,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n+}\r\n"
                },
                {
                    "date": 1768752935537,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,120 @@\n+// src/lib/pensionEngine.ts\r\n+\r\n+export type Payment = {\r\n+    paid: string;        // YYYY-MM-DD (UTC)\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n+};\r\n+\r\n+export type PensionResult = {\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n+};\r\n+\r\n+// VERIFIED DWP GRID ANCHOR\r\n+const BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\n+const BASE_NI = \"00A\";\r\n+\r\n+/* ------------------------------------------------------------\r\n+   DATE HELPERS (UTC SAFE)\r\n+------------------------------------------------------------ */\r\n+\r\n+function addDaysUTC(date: Date, days: number): Date {\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n+}\r\n+\r\n+function formatISO(date: Date): string {\r\n+    return date.toISOString().slice(0, 10);\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n+------------------------------------------------------------ */\r\n+\r\n+function parseNI(ni: string): { digits: number; letter: string } {\r\n+    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+    return { digits: +m[1], letter: m[2] };\r\n+}\r\n+\r\n+function rowFromDigits(d: number): number {\r\n+    if (d <= 19) return 0;\r\n+    if (d <= 39) return 1;\r\n+    if (d <= 59) return 2;\r\n+    if (d <= 79) return 3;\r\n+    return 4;\r\n+}\r\n+\r\n+\r\n+function niOffsetDays(ni: string): number {\r\n+    const base = parseNI(BASE_NI);\r\n+    const target = parseNI(ni);\r\n+\r\n+    const rowOffset =\r\n+        rowFromDigits(target.digits) - rowFromDigits(base.digits);\r\n+\r\n+    const colOffset =\r\n+        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+\r\n+    return rowOffset + colOffset;\r\n+}\r\n+\r\n+\r\n+/* ------------------------------------------------------------\r\n+   MAIN ENGINE\r\n+------------------------------------------------------------ */\r\n+\r\n+\r\n+export function generatePayments(\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28\r\n+): PensionResult {\r\n+\r\n+    if (![7, 14, 28].includes(cycleDays)) {\r\n+        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+    }\r\n+\r\n+    // 1️⃣ Anchor this NI to the real DWP grid\r\n+    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+\r\n+    // 2️⃣ Rewind far enough to cover requested range\r\n+    while (d.getUTCFullYear() > startYear) {\r\n+        d = addDaysUTC(d, -cycleDays);\r\n+    }\r\n+\r\n+    // 3️⃣ Move forward into range\r\n+    while (d.getUTCFullYear() < startYear) {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    const payments: Payment[] = [];\r\n+\r\n+    // 4️⃣ Collect payments\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        payments.push({\r\n+            paid: formatISO(d),\r\n+            early: false\r\n+        });\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n+    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+        .toLocaleDateString(\"en-GB\", {\r\n+            weekday: \"long\",\r\n+            timeZone: \"UTC\"\r\n+        });\r\n+\r\n+    return {\r\n+        ni,\r\n+        normalDay,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n+}\r\n"
                },
                {
                    "date": 1768753690208,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,122 @@\n+// src/lib/pensionEngine.ts\r\n+\r\n+export type Payment = {\r\n+    paid: string;        // YYYY-MM-DD (UTC)\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n+};\r\n+\r\n+export type PensionResult = {\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n+};\r\n+\r\n+// VERIFIED DWP GRID ANCHOR\r\n+const BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\n+const BASE_NI = \"00A\";\r\n+\r\n+/* ------------------------------------------------------------\r\n+   DATE HELPERS (UTC SAFE)\r\n+------------------------------------------------------------ */\r\n+\r\n+function addDaysUTC(date: Date, days: number): Date {\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n+}\r\n+\r\n+function formatISO(date: Date): string {\r\n+    return date.toISOString().slice(0, 10);\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n+------------------------------------------------------------ */\r\n+\r\n+function parseNI(ni: string): { digits: number; letter: string } {\r\n+    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+    return { digits: +m[1], letter: m[2] };\r\n+}\r\n+\r\n+function rowFromDigits(d: number): number {\r\n+    if (d <= 19) return 0;\r\n+    if (d <= 39) return 1;\r\n+    if (d <= 59) return 2;\r\n+    if (d <= 79) return 3;\r\n+    return 4;\r\n+}\r\n+\r\n+\r\n+function niOffsetDays(ni: string): number {\r\n+    const base = parseNI(BASE_NI);\r\n+    const target = parseNI(ni);\r\n+\r\n+    const rowOffset =\r\n+        rowFromDigits(target.digits) - rowFromDigits(base.digits);\r\n+\r\n+    const colOffset =\r\n+        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+\r\n+    return rowOffset + colOffset;\r\n+}\r\n+\r\n+\r\n+/* ------------------------------------------------------------\r\n+   MAIN ENGINE\r\n+------------------------------------------------------------ */\r\n+\r\n+\r\n+export function generatePayments(\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28\r\n+): PensionResult {\r\n+\r\n+    if (![7, 14, 28].includes(cycleDays)) {\r\n+        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+    }\r\n+\r\n+    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+\r\n+    const startBoundary = new Date(Date.UTC(startYear, 0, 1));\r\n+    const endBoundary = new Date(Date.UTC(endYear + 1, 0, 1));\r\n+\r\n+    // 2️⃣ Rewind until before the start boundary\r\n+    while (d >= startBoundary) {\r\n+        d = addDaysUTC(d, -cycleDays);\r\n+    }\r\n+\r\n+    // 3️⃣ Move to first payment >= startBoundary\r\n+    do {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    } while (d < startBoundary);\r\n+\r\n+    const payments: Payment[] = [];\r\n+\r\n+    // 4️⃣ Collect payments until end boundary\r\n+    while (d < endBoundary) {\r\n+        payments.push({\r\n+            paid: formatISO(d),\r\n+            early: false\r\n+        });\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n+\r\n+    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n+    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+        .toLocaleDateString(\"en-GB\", {\r\n+            weekday: \"long\",\r\n+            timeZone: \"UTC\"\r\n+        });\r\n+\r\n+    return {\r\n+        ni,\r\n+        normalDay,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n+}\r\n"
                },
                {
                    "date": 1768754280528,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -63,131 +63,37 @@\n     return rowOffset + colOffset;\r\n }\r\n \r\n \r\n-/* ------------------------------------------------------------\r\n-   MAIN ENGINE\r\n------------------------------------------------------------- */\r\n+function adjustForNonWorkingDays(\r\n+  date: Date,\r\n+  bankHolidays: Record<string, string>\r\n+): { date: Date; early: boolean; holidays: string[] } {\r\n \r\n+  let d = new Date(date);\r\n+  const holidays: string[] = [];\r\n+  let early = false;\r\n \r\n-export function generatePayments(\r\n-    ni: string,\r\n-    startYear: number,\r\n-    endYear: number,\r\n-    cycleDays: number = 28\r\n-): PensionResult {\r\n+  while (true) {\r\n+    const iso = d.toISOString().slice(0, 10);\r\n+    const dow = d.getUTCDay();\r\n \r\n-    if (![7, 14, 28].includes(cycleDays)) {\r\n-        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-    }\r\n+    const isWeekend = dow === 0 || dow === 6;\r\n+    const isHoliday = !!bankHolidays[iso];\r\n \r\n-    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+    if (!isWeekend && !isHoliday) break;\r\n \r\n-    const startBoundary = new Date(Date.UTC(startYear, 0, 1));\r\n-    const endBoundary = new Date(Date.UTC(endYear + 1, 0, 1));\r\n+    early = true;\r\n+    if (isHoliday) holidays.push(bankHolidays[iso]);\r\n \r\n-    // 2️⃣ Rewind until before the start boundary\r\n-    while (d >= startBoundary) {\r\n-        d = addDaysUTC(d, -cycleDays);\r\n-    }\r\n+    d.setUTCDate(d.getUTCDate() - 1);\r\n+  }\r\n \r\n-    // 3️⃣ Move to first payment >= startBoundary\r\n-    do {\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    } while (d < startBoundary);\r\n-\r\n-    const payments: Payment[] = [];\r\n-\r\n-    // 4️⃣ Collect payments until end boundary\r\n-    while (d < endBoundary) {\r\n-        payments.push({\r\n-            paid: formatISO(d),\r\n-            early: false\r\n-        });\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n-    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n-        .toLocaleDateString(\"en-GB\", {\r\n-            weekday: \"long\",\r\n-            timeZone: \"UTC\"\r\n-        });\r\n-\r\n-    return {\r\n-        ni,\r\n-        normalDay,\r\n-        cycleDays,\r\n-        payments\r\n-    };\r\n+  return { date: d, early, holidays };\r\n }\r\n-// src/lib/pensionEngine.ts\r\n \r\n-export type Payment = {\r\n-    paid: string;        // YYYY-MM-DD (UTC)\r\n-    early: boolean;\r\n-    holidays?: string[];\r\n-};\r\n \r\n-export type PensionResult = {\r\n-    ni: string;\r\n-    normalDay: string;\r\n-    cycleDays: number;\r\n-    payments: Payment[];\r\n-};\r\n-\r\n-// VERIFIED DWP GRID ANCHOR\r\n-const BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\n-const BASE_NI = \"00A\";\r\n-\r\n /* ------------------------------------------------------------\r\n-   DATE HELPERS (UTC SAFE)\r\n------------------------------------------------------------- */\r\n-\r\n-function addDaysUTC(date: Date, days: number): Date {\r\n-    const d = new Date(date);\r\n-    d.setUTCDate(d.getUTCDate() + days);\r\n-    return d;\r\n-}\r\n-\r\n-function formatISO(date: Date): string {\r\n-    return date.toISOString().slice(0, 10);\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n------------------------------------------------------------- */\r\n-\r\n-function parseNI(ni: string): { digits: number; letter: string } {\r\n-    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n-    return { digits: +m[1], letter: m[2] };\r\n-}\r\n-\r\n-function rowFromDigits(d: number): number {\r\n-    if (d <= 19) return 0;\r\n-    if (d <= 39) return 1;\r\n-    if (d <= 59) return 2;\r\n-    if (d <= 79) return 3;\r\n-    return 4;\r\n-}\r\n-\r\n-\r\n-function niOffsetDays(ni: string): number {\r\n-    const base = parseNI(BASE_NI);\r\n-    const target = parseNI(ni);\r\n-\r\n-    const rowOffset =\r\n-        rowFromDigits(target.digits) - rowFromDigits(base.digits);\r\n-\r\n-    const colOffset =\r\n-        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n-\r\n-    return rowOffset + colOffset;\r\n-}\r\n-\r\n-\r\n-/* ------------------------------------------------------------\r\n    MAIN ENGINE\r\n ------------------------------------------------------------ */\r\n \r\n \r\n@@ -201,143 +107,27 @@\n     if (![7, 14, 28].includes(cycleDays)) {\r\n         throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n     }\r\n \r\n-    // 1️⃣ Anchor this NI to the real DWP grid\r\n     let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n \r\n-    // 2️⃣ Rewind far enough to cover requested range\r\n-    while (d.getUTCFullYear() > startYear) {\r\n-        d = addDaysUTC(d, -cycleDays);\r\n-    }\r\n+    const startBoundary = new Date(Date.UTC(startYear, 0, 1));\r\n+    const endBoundary = new Date(Date.UTC(endYear + 1, 0, 1));\r\n \r\n-    // 3️⃣ Move forward into range\r\n-    while (d.getUTCFullYear() < startYear) {\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    const payments: Payment[] = [];\r\n-\r\n-    // 4️⃣ Collect payments\r\n-    while (d.getUTCFullYear() <= endYear) {\r\n-        payments.push({\r\n-            paid: formatISO(d),\r\n-            early: false\r\n-        });\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n-    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n-        .toLocaleDateString(\"en-GB\", {\r\n-            weekday: \"long\",\r\n-            timeZone: \"UTC\"\r\n-        });\r\n-\r\n-    return {\r\n-        ni,\r\n-        normalDay,\r\n-        cycleDays,\r\n-        payments\r\n-    };\r\n-}\r\n-// src/lib/pensionEngine.ts\r\n-\r\n-export type Payment = {\r\n-    paid: string;        // YYYY-MM-DD (UTC)\r\n-    early: boolean;\r\n-    holidays?: string[];\r\n-};\r\n-\r\n-export type PensionResult = {\r\n-    ni: string;\r\n-    normalDay: string;\r\n-    cycleDays: number;\r\n-    payments: Payment[];\r\n-};\r\n-\r\n-// VERIFIED DWP GRID ANCHOR\r\n-const BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\n-const BASE_NI = \"00A\";\r\n-\r\n-/* ------------------------------------------------------------\r\n-   DATE HELPERS (UTC SAFE)\r\n------------------------------------------------------------- */\r\n-\r\n-function addDaysUTC(date: Date, days: number): Date {\r\n-    const d = new Date(date);\r\n-    d.setUTCDate(d.getUTCDate() + days);\r\n-    return d;\r\n-}\r\n-\r\n-function formatISO(date: Date): string {\r\n-    return date.toISOString().slice(0, 10);\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n------------------------------------------------------------- */\r\n-\r\n-function parseNI(ni: string): { digits: number; letter: string } {\r\n-    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n-    return { digits: +m[1], letter: m[2] };\r\n-}\r\n-\r\n-function rowFromDigits(d: number): number {\r\n-    if (d <= 19) return 0;\r\n-    if (d <= 39) return 1;\r\n-    if (d <= 59) return 2;\r\n-    if (d <= 79) return 3;\r\n-    return 4;\r\n-}\r\n-\r\n-function niOffsetDays(ni: string): number {\r\n-    const base = parseNI(BASE_NI);\r\n-    const target = parseNI(ni);\r\n-\r\n-    const rowOffset =\r\n-        (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n-\r\n-    const colOffset =\r\n-        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n-\r\n-    return rowOffset + colOffset;\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   MAIN ENGINE\r\n------------------------------------------------------------- */\r\n-\r\n-\r\n-export function generatePayments(\r\n-    ni: string,\r\n-    startYear: number,\r\n-    endYear: number,\r\n-    cycleDays: number = 28\r\n-): PensionResult {\r\n-\r\n-    if (![7, 14, 28].includes(cycleDays)) {\r\n-        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-    }\r\n-\r\n-    // 1️⃣ Anchor this NI to the real DWP grid\r\n-    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n-\r\n-    // 2️⃣ Rewind far enough to cover requested range\r\n-    while (d.getUTCFullYear() > startYear) {\r\n+    // 2️⃣ Rewind until before the start boundary\r\n+    while (d >= startBoundary) {\r\n         d = addDaysUTC(d, -cycleDays);\r\n     }\r\n \r\n-    // 3️⃣ Move forward into range\r\n-    while (d.getUTCFullYear() < startYear) {\r\n+    // 3️⃣ Move to first payment >= startBoundary\r\n+    do {\r\n         d = addDaysUTC(d, cycleDays);\r\n-    }\r\n+    } while (d < startBoundary);\r\n \r\n     const payments: Payment[] = [];\r\n \r\n-    // 4️⃣ Collect payments\r\n-    while (d.getUTCFullYear() <= endYear) {\r\n+    // 4️⃣ Collect payments until end boundary\r\n+    while (d < endBoundary) {\r\n         payments.push({\r\n             paid: formatISO(d),\r\n             early: false\r\n         });\r\n@@ -357,623 +147,4 @@\n         cycleDays,\r\n         payments\r\n     };\r\n }\r\n-// src/lib/pensionEngine.ts\r\n-\r\n-export type Payment = {\r\n-    paid: string;        // YYYY-MM-DD (UTC)\r\n-    early: boolean;\r\n-    holidays?: string[];\r\n-};\r\n-\r\n-export type PensionResult = {\r\n-    ni: string;\r\n-    normalDay: string;\r\n-    cycleDays: number;\r\n-    payments: Payment[];\r\n-};\r\n-\r\n-/* ------------------------------------------------------------\r\n-   VERIFIED DWP ANCHOR\r\n------------------------------------------------------------- */\r\n-\r\n-// Confirmed real payment:\r\n-// NI 29B → Tuesday 6 January 2026\r\n-const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n-const BASE_NI = \"29B\";\r\n-\r\n-/* ------------------------------------------------------------\r\n-   DATE HELPERS (UTC SAFE)\r\n------------------------------------------------------------- */\r\n-\r\n-function addDaysUTC(date: Date, days: number): Date {\r\n-    const d = new Date(date);\r\n-    d.setUTCDate(d.getUTCDate() + days);\r\n-    return d;\r\n-}\r\n-\r\n-function formatISO(date: Date): string {\r\n-    return date.toISOString().slice(0, 10);\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n------------------------------------------------------------- */\r\n-\r\n-function parseNI(ni: string): { digits: number; letter: string } {\r\n-    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n-    return { digits: +m[1], letter: m[2] };\r\n-}\r\n-\r\n-function rowFromDigits(d: number): number {\r\n-    if (d <= 19) return 0;\r\n-    if (d <= 39) return 1;\r\n-    if (d <= 59) return 2;\r\n-    if (d <= 79) return 3;\r\n-    return 4;\r\n-}\r\n-\r\n-function niOffsetDays(ni: string): number {\r\n-    const base = parseNI(BASE_NI);\r\n-    const target = parseNI(ni);\r\n-\r\n-    const rowOffset =\r\n-        (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n-\r\n-    const colOffset =\r\n-        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n-\r\n-    return rowOffset + colOffset;\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   MAIN ENGINE\r\n------------------------------------------------------------- */\r\n-\r\n-\r\n-export function generatePayments(\r\n-    ni: string,\r\n-    startYear: number,\r\n-    endYear: number,\r\n-    cycleDays: number = 28\r\n-): PensionResult {\r\n-\r\n-    if (![7, 14, 28].includes(cycleDays)) {\r\n-        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-    }\r\n-\r\n-    // 1️⃣ Anchor this NI to the real DWP grid\r\n-    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n-\r\n-    // 2️⃣ Rewind far enough to cover requested range\r\n-    while (d.getUTCFullYear() > startYear) {\r\n-        d = addDaysUTC(d, -cycleDays);\r\n-    }\r\n-\r\n-    // 3️⃣ Move forward into range\r\n-    while (d.getUTCFullYear() < startYear) {\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    const payments: Payment[] = [];\r\n-\r\n-    // 4️⃣ Collect payments\r\n-    while (d.getUTCFullYear() <= endYear) {\r\n-        payments.push({\r\n-            paid: formatISO(d),\r\n-            early: false\r\n-        });\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n-    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n-        .toLocaleDateString(\"en-GB\", {\r\n-            weekday: \"long\",\r\n-            timeZone: \"UTC\"\r\n-        });\r\n-\r\n-    return {\r\n-        ni,\r\n-        normalDay,\r\n-        cycleDays,\r\n-        payments\r\n-    };\r\n-}\r\n-// src/lib/pensionEngine.ts\r\n-\r\n-export type Payment = {\r\n-    paid: string;        // YYYY-MM-DD (UTC)\r\n-    early: boolean;\r\n-    holidays?: string[];\r\n-};\r\n-\r\n-export type PensionResult = {\r\n-    ni: string;\r\n-    normalDay: string;\r\n-    cycleDays: number;\r\n-    payments: Payment[];\r\n-};\r\n-\r\n-/* ------------------------------------------------------------\r\n-   VERIFIED DWP ANCHOR\r\n------------------------------------------------------------- */\r\n-\r\n-// Confirmed real payment:\r\n-// NI 29B → Tuesday 6 January 2026\r\n-const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n-const BASE_NI = \"29B\";\r\n-\r\n-/* ------------------------------------------------------------\r\n-   DATE HELPERS (UTC SAFE)\r\n------------------------------------------------------------- */\r\n-\r\n-function addDaysUTC(date: Date, days: number): Date {\r\n-    const d = new Date(date);\r\n-    d.setUTCDate(d.getUTCDate() + days);\r\n-    return d;\r\n-}\r\n-\r\n-function formatISO(date: Date): string {\r\n-    return date.toISOString().slice(0, 10);\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n------------------------------------------------------------- */\r\n-\r\n-function parseNI(ni: string): { digits: number; letter: string } {\r\n-    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n-    return { digits: +m[1], letter: m[2] };\r\n-}\r\n-\r\n-function rowFromDigits(d: number): number {\r\n-    if (d <= 19) return 0;\r\n-    if (d <= 39) return 1;\r\n-    if (d <= 59) return 2;\r\n-    if (d <= 79) return 3;\r\n-    return 4;\r\n-}\r\n-\r\n-function niOffsetDays(ni: string): number {\r\n-    const base = parseNI(BASE_NI);\r\n-    const target = parseNI(ni);\r\n-\r\n-    const rowOffset =\r\n-        (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n-\r\n-    const colOffset =\r\n-        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n-\r\n-    return rowOffset + colOffset;\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   MAIN ENGINE\r\n------------------------------------------------------------- */\r\n-\r\n-function getPaymentWeekdayFromNI(ni: string): {\r\n-    jsWeekday: number;\r\n-    weekdayName: string;\r\n-} {\r\n-    const match = ni.toUpperCase().match(/(\\d{2})[A-Z]?$/);\r\n-\r\n-    if (!match) {\r\n-        throw new Error(`NI parsing failed: ${ni}`);\r\n-    }\r\n-\r\n-    const n = parseInt(match[1], 10);\r\n-\r\n-    if (n <= 19) return { jsWeekday: 1, weekdayName: \"Monday\" };\r\n-    if (n <= 39) return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n-    if (n <= 59) return { jsWeekday: 3, weekdayName: \"Wednesday\" };\r\n-    if (n <= 79) return { jsWeekday: 4, weekdayName: \"Thursday\" };\r\n-    return { jsWeekday: 5, weekdayName: \"Friday\" };\r\n-}\r\n-\r\n-export function generatePayments(\r\n-    ni: string,\r\n-    startYear: number,\r\n-    endYear: number,\r\n-    cycleDays: number = 28\r\n-): PensionResult {\r\n-\r\n-    if (![7, 14, 28].includes(cycleDays)) {\r\n-        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-    }\r\n-\r\n-    // 1️⃣ Anchor this NI to the real DWP grid\r\n-    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n-\r\n-    // 2️⃣ Rewind far enough to cover requested range\r\n-    while (d.getUTCFullYear() > startYear) {\r\n-        d = addDaysUTC(d, -cycleDays);\r\n-    }\r\n-\r\n-    // 3️⃣ Move forward into range\r\n-    while (d.getUTCFullYear() < startYear) {\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    const payments: Payment[] = [];\r\n-\r\n-    // 4️⃣ Collect payments\r\n-    while (d.getUTCFullYear() <= endYear) {\r\n-        payments.push({\r\n-            paid: formatISO(d),\r\n-            early: false\r\n-        });\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n-    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n-        .toLocaleDateString(\"en-GB\", {\r\n-            weekday: \"long\",\r\n-            timeZone: \"UTC\"\r\n-        });\r\n-\r\n-    return {\r\n-        ni,\r\n-        normalDay,\r\n-        cycleDays,\r\n-        payments\r\n-    };\r\n-}\r\n-// src/lib/pensionEngine.ts\r\n-\r\n-export type Payment = {\r\n-    paid: string;        // YYYY-MM-DD (UTC)\r\n-    early: boolean;\r\n-    holidays?: string[];\r\n-};\r\n-\r\n-export type PensionResult = {\r\n-    ni: string;\r\n-    normalDay: string;\r\n-    cycleDays: number;\r\n-    payments: Payment[];\r\n-};\r\n-\r\n-/* ------------------------------------------------------------\r\n-   VERIFIED DWP ANCHOR\r\n------------------------------------------------------------- */\r\n-\r\n-// Confirmed real payment:\r\n-// NI 29B → Tuesday 6 January 2026\r\n-const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n-const BASE_NI = \"29B\";\r\n-\r\n-/* ------------------------------------------------------------\r\n-   DATE HELPERS (UTC SAFE)\r\n------------------------------------------------------------- */\r\n-\r\n-function addDaysUTC(date: Date, days: number): Date {\r\n-    const d = new Date(date);\r\n-    d.setUTCDate(d.getUTCDate() + days);\r\n-    return d;\r\n-}\r\n-\r\n-function formatISO(date: Date): string {\r\n-    return date.toISOString().slice(0, 10);\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n------------------------------------------------------------- */\r\n-\r\n-function parseNI(ni: string): { digits: number; letter: string } {\r\n-    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n-    return { digits: +m[1], letter: m[2] };\r\n-}\r\n-\r\n-function rowFromDigits(d: number): number {\r\n-    if (d <= 19) return 0;\r\n-    if (d <= 39) return 1;\r\n-    if (d <= 59) return 2;\r\n-    if (d <= 79) return 3;\r\n-    return 4;\r\n-}\r\n-\r\n-function niOffsetDays(ni: string): number {\r\n-    const base = parseNI(BASE_NI);\r\n-    const target = parseNI(ni);\r\n-\r\n-    const rowOffset =\r\n-        (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n-\r\n-    const colOffset =\r\n-        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n-\r\n-    return rowOffset + colOffset;\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   MAIN ENGINE\r\n------------------------------------------------------------- */\r\n-\r\n-export function generatePayments(\r\n-    ni: string,\r\n-    startYear: number,\r\n-    endYear: number,\r\n-    cycleDays: number = 28\r\n-): PensionResult {\r\n-\r\n-    if (![7, 14, 28].includes(cycleDays)) {\r\n-        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-    }\r\n-\r\n-    // 1️⃣ Anchor this NI to the real DWP grid\r\n-    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n-\r\n-    // 2️⃣ Rewind far enough to cover requested range\r\n-    while (d.getUTCFullYear() > startYear) {\r\n-        d = addDaysUTC(d, -cycleDays);\r\n-    }\r\n-\r\n-    // 3️⃣ Move forward into range\r\n-    while (d.getUTCFullYear() < startYear) {\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    const payments: Payment[] = [];\r\n-\r\n-    // 4️⃣ Collect payments\r\n-    while (d.getUTCFullYear() <= endYear) {\r\n-        payments.push({\r\n-            paid: formatISO(d),\r\n-            early: false\r\n-        });\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n-    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n-        .toLocaleDateString(\"en-GB\", {\r\n-            weekday: \"long\",\r\n-            timeZone: \"UTC\"\r\n-        });\r\n-\r\n-    return {\r\n-        ni,\r\n-        normalDay,\r\n-        cycleDays,\r\n-        payments\r\n-    };\r\n-}\r\n-// src/lib/pensionEngine.ts\r\n-\r\n-export type Payment = {\r\n-    paid: string;        // YYYY-MM-DD (UTC)\r\n-    early: boolean;\r\n-    holidays?: string[];\r\n-};\r\n-\r\n-export type PensionResult = {\r\n-    ni: string;\r\n-    normalDay: string;\r\n-    cycleDays: number;\r\n-    payments: Payment[];\r\n-};\r\n-\r\n-/* ------------------------------------------------------------\r\n-   CONSTANTS\r\n------------------------------------------------------------- */\r\n-\r\n-// Confirmed real DWP anchor:\r\n-// NI 29B was paid on Tuesday 6 Jan 2026\r\n-const BASE_DATE = new Date(Date.UTC(2026, 0, 6)); // 2026-01-06 (Tuesday)\r\n-const BASE_NI = \"29B\";\r\n-\r\n-/* ------------------------------------------------------------\r\n-   DATE HELPERS (UTC SAFE)\r\n------------------------------------------------------------- */\r\n-\r\n-function addDaysUTC(date: Date, days: number): Date {\r\n-    const d = new Date(date);\r\n-    d.setUTCDate(d.getUTCDate() + days);\r\n-    return d;\r\n-}\r\n-\r\n-function formatISO(date: Date): string {\r\n-    return date.toISOString().slice(0, 10);\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   NI OFFSET LOGIC (RELATIVE TO BASE_NI)\r\n------------------------------------------------------------- */\r\n-\r\n-function parseNI(ni: string): { digits: number; letter: string } {\r\n-    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-    if (!m) {\r\n-        throw new Error(`NI parsing failed: ${ni}`);\r\n-    }\r\n-    return {\r\n-        digits: parseInt(m[1], 10),\r\n-        letter: m[2]\r\n-    };\r\n-}\r\n-\r\n-/**\r\n- * Returns the day-offset (multiple of 7) between BASE_NI and target NI\r\n- * This preserves the national DWP payment grid.\r\n- */\r\n-function niOffsetDays(ni: string): number {\r\n-    const base = parseNI(BASE_NI);\r\n-    const target = parseNI(ni);\r\n-\r\n-    // Letter offset (columns): A–D = 0–3 weeks\r\n-    const letterOffset =\r\n-        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n-\r\n-    // Digit offset (rows)\r\n-    function row(d: number): number {\r\n-        if (d <= 19) return 0;\r\n-        if (d <= 39) return 1;\r\n-        if (d <= 59) return 2;\r\n-        if (d <= 79) return 3;\r\n-        return 4;\r\n-    }\r\n-\r\n-    const digitOffset =\r\n-        (row(target.digits) - row(base.digits)) * 7;\r\n-\r\n-    return letterOffset + digitOffset;\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   MAIN ENGINE\r\n------------------------------------------------------------- */\r\n-\r\n-export function generatePayments(\r\n-    ni: string,\r\n-    startYear: number,\r\n-    endYear: number,\r\n-    cycleDays: number = 28\r\n-): PensionResult {\r\n-\r\n-    if (![7, 14, 28].includes(cycleDays)) {\r\n-        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-    }\r\n-\r\n-    const offsetDays = niOffsetDays(ni);\r\n-\r\n-    // Anchor this NI to the real DWP grid\r\n-    let d = addDaysUTC(BASE_DATE, offsetDays);\r\n-\r\n-    const payments: Payment[] = [];\r\n-\r\n-    // Rewind if anchor is after requested range\r\n-    while (d.getUTCFullYear() > endYear) {\r\n-        d = addDaysUTC(d, -cycleDays);\r\n-    }\r\n-\r\n-    // Fast-forward into range\r\n-    while (d.getUTCFullYear() < startYear) {\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    // Collect payments\r\n-    while (d.getUTCFullYear() <= endYear) {\r\n-        payments.push({\r\n-            paid: formatISO(d),\r\n-            early: false\r\n-        });\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    const weekdayName = new Date(\r\n-        Date.UTC(2026, 0, 6)\r\n-    ).toLocaleDateString(\"en-GB\", {\r\n-        weekday: \"long\",\r\n-        timeZone: \"UTC\"\r\n-    });\r\n-\r\n-    return {\r\n-        ni,\r\n-        normalDay: weekdayName,\r\n-        cycleDays,\r\n-        payments\r\n-    };\r\n-}\r\n-// src/lib/pensionEngine.ts\r\n-\r\n-export type Payment = {\r\n-    paid: string;        // YYYY-MM-DD\r\n-    early: boolean;\r\n-    holidays?: string[];\r\n-};\r\n-\r\n-export type PensionResult = {\r\n-    ni: string;\r\n-    normalDay: string;\r\n-    cycleDays: number;\r\n-    payments: Payment[];\r\n-};\r\n-\r\n-/* ------------------------------------------------------------\r\n-   Helpers\r\n------------------------------------------------------------- */\r\n-\r\n-function addDaysUTC(date: Date, days: number): Date {\r\n-    const d = new Date(date);\r\n-    d.setUTCDate(d.getUTCDate() + days);\r\n-    return d;\r\n-}\r\n-\r\n-function formatISO(date: Date): string {\r\n-    return date.toISOString().slice(0, 10);\r\n-}\r\n-\r\n-\r\n-function getPaymentWeekdayFromNI(ni: string): {\r\n-    jsWeekday: number;\r\n-    weekdayName: string;\r\n-} {\r\n-    ni = ni.trim().toUpperCase();\r\n-\r\n-    const match = ni.match(/(\\d{2})[A-D]$/);\r\n-\r\n-    if (!match) {\r\n-        throw new Error(\"NI parsing failed: \" + ni);\r\n-    }\r\n-\r\n-    const n = parseInt(match[1], 10);\r\n-\r\n-    if (n <= 19) return { jsWeekday: 1, weekdayName: \"Monday\" };\r\n-    if (n <= 39) return { jsWeekday: 2, weekdayName: \"Tuesday\" };\r\n-    if (n <= 59) return { jsWeekday: 3, weekdayName: \"Wednesday\" };\r\n-    if (n <= 79) return { jsWeekday: 4, weekdayName: \"Thursday\" };\r\n-    return { jsWeekday: 5, weekdayName: \"Friday\" };\r\n-}\r\n-\r\n-\r\n-/* ------------------------------------------------------------\r\n-   MAIN ENGINE\r\n------------------------------------------------------------- */\r\n-\r\n-export function generatePayments(\r\n-    ni: string,\r\n-    startYear: number,\r\n-    endYear: number,\r\n-    cycleDays: number = 28\r\n-): PensionResult {\r\n-\r\n-\r\n-\r\n-    const payments: Payment[] = [];\r\n-\r\n-    const { jsWeekday, weekdayName } = getPaymentWeekdayFromNI(ni);\r\n-\r\n-    // 2024-01-01 was a Monday\r\n-    let d = new Date(Date.UTC(2024, 0, 1));\r\n-\r\n-    // Move forward until weekday matches NI rule\r\n-    while (d.getUTCDay() !== jsWeekday) {\r\n-        d = addDaysUTC(d, 1);\r\n-    }\r\n-\r\n-    // Fast-forward to startYear\r\n-    while (d.getUTCFullYear() < startYear) {\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    while (d.getUTCFullYear() <= endYear) {\r\n-        payments.push({\r\n-            paid: formatISO(d),\r\n-            early: false\r\n-        });\r\n-\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    return {\r\n-        ni,\r\n-        normalDay: weekdayName,\r\n-        cycleDays,\r\n-        payments\r\n-    };\r\n-}\r\n"
                },
                {
                    "date": 1768754437770,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,32 +64,32 @@\n }\r\n \r\n \r\n function adjustForNonWorkingDays(\r\n-  date: Date,\r\n-  bankHolidays: Record<string, string>\r\n+    date: Date,\r\n+    bankHolidays: Record<string, string>\r\n ): { date: Date; early: boolean; holidays: string[] } {\r\n \r\n-  let d = new Date(date);\r\n-  const holidays: string[] = [];\r\n-  let early = false;\r\n+    let d = new Date(date);\r\n+    const holidays: string[] = [];\r\n+    let early = false;\r\n \r\n-  while (true) {\r\n-    const iso = d.toISOString().slice(0, 10);\r\n-    const dow = d.getUTCDay();\r\n+    while (true) {\r\n+        const iso = d.toISOString().slice(0, 10);\r\n+        const dow = d.getUTCDay();\r\n \r\n-    const isWeekend = dow === 0 || dow === 6;\r\n-    const isHoliday = !!bankHolidays[iso];\r\n+        const isWeekend = dow === 0 || dow === 6;\r\n+        const isHoliday = !!bankHolidays[iso];\r\n \r\n-    if (!isWeekend && !isHoliday) break;\r\n+        if (!isWeekend && !isHoliday) break;\r\n \r\n-    early = true;\r\n-    if (isHoliday) holidays.push(bankHolidays[iso]);\r\n+        early = true;\r\n+        if (isHoliday) holidays.push(bankHolidays[iso]);\r\n \r\n-    d.setUTCDate(d.getUTCDate() - 1);\r\n-  }\r\n+        d.setUTCDate(d.getUTCDate() - 1);\r\n+    }\r\n \r\n-  return { date: d, early, holidays };\r\n+    return { date: d, early, holidays };\r\n }\r\n \r\n \r\n /* ------------------------------------------------------------\r\n@@ -124,14 +124,17 @@\n     } while (d < startBoundary);\r\n \r\n     const payments: Payment[] = [];\r\n \r\n-    // 4️⃣ Collect payments until end boundary\r\n-    while (d < endBoundary) {\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n+\r\n         payments.push({\r\n-            paid: formatISO(d),\r\n-            early: false\r\n+            paid: formatISO(adjusted.date),\r\n+            early: adjusted.early,\r\n+            holidays: adjusted.holidays\r\n         });\r\n+\r\n         d = addDaysUTC(d, cycleDays);\r\n     }\r\n \r\n     // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n"
                },
                {
                    "date": 1768754559555,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -100,9 +100,10 @@\n export function generatePayments(\r\n     ni: string,\r\n     startYear: number,\r\n     endYear: number,\r\n-    cycleDays: number = 28\r\n+    cycleDays: number = 28,\r\n+    bankHolidays: Record<string, string> = {}\r\n ): PensionResult {\r\n \r\n     if (![7, 14, 28].includes(cycleDays)) {\r\n         throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n"
                },
                {
                    "date": 1768754788526,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -127,9 +127,9 @@\n     const payments: Payment[] = [];\r\n \r\n     while (d.getUTCFullYear() <= endYear) {\r\n         const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n-\r\n+        console.log(\"RAW\", formatISO(d), \"→ ADJ\", formatISO(adjusted.date));\r\n         payments.push({\r\n             paid: formatISO(adjusted.date),\r\n             early: adjusted.early,\r\n             holidays: adjusted.holidays\r\n"
                },
                {
                    "date": 1768754833049,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -127,9 +127,9 @@\n     const payments: Payment[] = [];\r\n \r\n     while (d.getUTCFullYear() <= endYear) {\r\n         const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n-        console.log(\"RAW\", formatISO(d), \"→ ADJ\", formatISO(adjusted.date));\r\n+        //console.log(\"RAW\", formatISO(d), \"→ ADJ\", formatISO(adjusted.date));\r\n         payments.push({\r\n             paid: formatISO(adjusted.date),\r\n             early: adjusted.early,\r\n             holidays: adjusted.holidays\r\n"
                },
                {
                    "date": 1768756665613,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,169 @@\n+// src/lib/pensionEngine.ts\r\n+\r\n+export type Payment = {\r\n+  paid: string;        // YYYY-MM-DD (UTC)\r\n+  early: boolean;\r\n+  holidays?: string[];\r\n+};\r\n+\r\n+export type PensionResult = {\r\n+  ni: string;\r\n+  normalDay: string;\r\n+  cycleDays: number;\r\n+  payments: Payment[];\r\n+};\r\n+\r\n+/* ------------------------------------------------------------\r\n+   VERIFIED DWP ANCHOR\r\n+------------------------------------------------------------ */\r\n+\r\n+// Known real payment:\r\n+// NI 29B → Tuesday 6 Jan 2026\r\n+const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n+const BASE_NI = \"29B\";\r\n+\r\n+/* ------------------------------------------------------------\r\n+   DATE HELPERS (UTC SAFE)\r\n+------------------------------------------------------------ */\r\n+\r\n+function addDaysUTC(date: Date, days: number): Date {\r\n+  const d = new Date(date);\r\n+  d.setUTCDate(d.getUTCDate() + days);\r\n+  return d;\r\n+}\r\n+\r\n+function formatISO(date: Date): string {\r\n+  return date.toISOString().slice(0, 10);\r\n+}\r\n+\r\n+function isWeekendUTC(d: Date): boolean {\r\n+  const day = d.getUTCDay();\r\n+  return day === 0 || day === 6;\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n+------------------------------------------------------------ */\r\n+\r\n+function parseNI(ni: string): { digits: number; letter: string } {\r\n+  const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+  if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+  return { digits: +m[1], letter: m[2] };\r\n+}\r\n+\r\n+function rowFromDigits(d: number): number {\r\n+  if (d <= 19) return 0;\r\n+  if (d <= 39) return 1;\r\n+  if (d <= 59) return 2;\r\n+  if (d <= 79) return 3;\r\n+  return 4;\r\n+}\r\n+\r\n+function niOffsetDays(ni: string): number {\r\n+  const base = parseNI(BASE_NI);\r\n+  const target = parseNI(ni);\r\n+\r\n+  const rowOffset =\r\n+    (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n+\r\n+  const colOffset =\r\n+    (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+\r\n+  return rowOffset + colOffset;\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   BANK HOLIDAY ADJUSTMENT (EARLY ONLY)\r\n+------------------------------------------------------------ */\r\n+\r\n+function adjustForNonWorkingDays(\r\n+  date: Date,\r\n+  bankHolidays: Record<string, string>\r\n+): { date: Date; early: boolean; holidays: string[] } {\r\n+\r\n+  let d = new Date(date);\r\n+  const reasons: string[] = [];\r\n+\r\n+  while (true) {\r\n+    const iso = formatISO(d);\r\n+\r\n+    if (isWeekendUTC(d)) {\r\n+      reasons.push(\"Weekend\");\r\n+      d = addDaysUTC(d, -1);\r\n+      continue;\r\n+    }\r\n+\r\n+    if (bankHolidays[iso]) {\r\n+      reasons.push(bankHolidays[iso]);\r\n+      d = addDaysUTC(d, -1);\r\n+      continue;\r\n+    }\r\n+\r\n+    break;\r\n+  }\r\n+\r\n+  return {\r\n+    date: d,\r\n+    early: d.getTime() !== date.getTime(),\r\n+    holidays: reasons\r\n+  };\r\n+}\r\n+\r\n+/* ------------------------------------------------------------\r\n+   MAIN ENGINE (LOCKED)\r\n+------------------------------------------------------------ */\r\n+\r\n+export function generatePayments(\r\n+  ni: string,\r\n+  startYear: number,\r\n+  endYear: number,\r\n+  cycleDays: number = 28,\r\n+  bankHolidays: Record<string, string>\r\n+): PensionResult {\r\n+\r\n+  if (![7, 14, 28].includes(cycleDays)) {\r\n+    throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+  }\r\n+\r\n+  // 1️⃣ Anchor NI to real DWP grid\r\n+  let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+\r\n+  // 2️⃣ Rewind to cover requested range\r\n+  while (d.getUTCFullYear() > startYear) {\r\n+    d = addDaysUTC(d, -cycleDays);\r\n+  }\r\n+\r\n+  // 3️⃣ Move forward into range\r\n+  while (d.getUTCFullYear() < startYear) {\r\n+    d = addDaysUTC(d, cycleDays);\r\n+  }\r\n+\r\n+  const payments: Payment[] = [];\r\n+\r\n+  // 4️⃣ Collect payments\r\n+  while (d.getUTCFullYear() <= endYear) {\r\n+    const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n+\r\n+    payments.push({\r\n+      paid: formatISO(adjusted.date),\r\n+      early: adjusted.early,\r\n+      holidays: adjusted.holidays.length ? adjusted.holidays : undefined\r\n+    });\r\n+\r\n+    d = addDaysUTC(d, cycleDays);\r\n+  }\r\n+\r\n+  // 5️⃣ Derive weekday name correctly\r\n+  const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+    .toLocaleDateString(\"en-GB\", {\r\n+      weekday: \"long\",\r\n+      timeZone: \"UTC\"\r\n+    });\r\n+\r\n+  return {\r\n+    ni,\r\n+    normalDay,\r\n+    cycleDays,\r\n+    payments\r\n+  };\r\n+}\r\n"
                },
                {
                    "date": 1768757115928,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -166,158 +166,4 @@\n     cycleDays,\r\n     payments\r\n   };\r\n }\r\n-// src/lib/pensionEngine.ts\r\n-\r\n-export type Payment = {\r\n-    paid: string;        // YYYY-MM-DD (UTC)\r\n-    early: boolean;\r\n-    holidays?: string[];\r\n-};\r\n-\r\n-export type PensionResult = {\r\n-    ni: string;\r\n-    normalDay: string;\r\n-    cycleDays: number;\r\n-    payments: Payment[];\r\n-};\r\n-\r\n-// VERIFIED DWP GRID ANCHOR\r\n-const BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\n-const BASE_NI = \"00A\";\r\n-\r\n-/* ------------------------------------------------------------\r\n-   DATE HELPERS (UTC SAFE)\r\n------------------------------------------------------------- */\r\n-\r\n-function addDaysUTC(date: Date, days: number): Date {\r\n-    const d = new Date(date);\r\n-    d.setUTCDate(d.getUTCDate() + days);\r\n-    return d;\r\n-}\r\n-\r\n-function formatISO(date: Date): string {\r\n-    return date.toISOString().slice(0, 10);\r\n-}\r\n-\r\n-/* ------------------------------------------------------------\r\n-   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n------------------------------------------------------------- */\r\n-\r\n-function parseNI(ni: string): { digits: number; letter: string } {\r\n-    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n-    return { digits: +m[1], letter: m[2] };\r\n-}\r\n-\r\n-function rowFromDigits(d: number): number {\r\n-    if (d <= 19) return 0;\r\n-    if (d <= 39) return 1;\r\n-    if (d <= 59) return 2;\r\n-    if (d <= 79) return 3;\r\n-    return 4;\r\n-}\r\n-\r\n-\r\n-function niOffsetDays(ni: string): number {\r\n-    const base = parseNI(BASE_NI);\r\n-    const target = parseNI(ni);\r\n-\r\n-    const rowOffset =\r\n-        rowFromDigits(target.digits) - rowFromDigits(base.digits);\r\n-\r\n-    const colOffset =\r\n-        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n-\r\n-    return rowOffset + colOffset;\r\n-}\r\n-\r\n-\r\n-function adjustForNonWorkingDays(\r\n-    date: Date,\r\n-    bankHolidays: Record<string, string>\r\n-): { date: Date; early: boolean; holidays: string[] } {\r\n-\r\n-    let d = new Date(date);\r\n-    const holidays: string[] = [];\r\n-    let early = false;\r\n-\r\n-    while (true) {\r\n-        const iso = d.toISOString().slice(0, 10);\r\n-        const dow = d.getUTCDay();\r\n-\r\n-        const isWeekend = dow === 0 || dow === 6;\r\n-        const isHoliday = !!bankHolidays[iso];\r\n-\r\n-        if (!isWeekend && !isHoliday) break;\r\n-\r\n-        early = true;\r\n-        if (isHoliday) holidays.push(bankHolidays[iso]);\r\n-\r\n-        d.setUTCDate(d.getUTCDate() - 1);\r\n-    }\r\n-\r\n-    return { date: d, early, holidays };\r\n-}\r\n-\r\n-\r\n-/* ------------------------------------------------------------\r\n-   MAIN ENGINE\r\n------------------------------------------------------------- */\r\n-\r\n-\r\n-export function generatePayments(\r\n-    ni: string,\r\n-    startYear: number,\r\n-    endYear: number,\r\n-    cycleDays: number = 28,\r\n-    bankHolidays: Record<string, string> = {}\r\n-): PensionResult {\r\n-\r\n-    if (![7, 14, 28].includes(cycleDays)) {\r\n-        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-    }\r\n-\r\n-    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n-\r\n-    const startBoundary = new Date(Date.UTC(startYear, 0, 1));\r\n-    const endBoundary = new Date(Date.UTC(endYear + 1, 0, 1));\r\n-\r\n-    // 2️⃣ Rewind until before the start boundary\r\n-    while (d >= startBoundary) {\r\n-        d = addDaysUTC(d, -cycleDays);\r\n-    }\r\n-\r\n-    // 3️⃣ Move to first payment >= startBoundary\r\n-    do {\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    } while (d < startBoundary);\r\n-\r\n-    const payments: Payment[] = [];\r\n-\r\n-    while (d.getUTCFullYear() <= endYear) {\r\n-        const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n-        //console.log(\"RAW\", formatISO(d), \"→ ADJ\", formatISO(adjusted.date));\r\n-        payments.push({\r\n-            paid: formatISO(adjusted.date),\r\n-            early: adjusted.early,\r\n-            holidays: adjusted.holidays\r\n-        });\r\n-\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    }\r\n-\r\n-    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n-    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n-        .toLocaleDateString(\"en-GB\", {\r\n-            weekday: \"long\",\r\n-            timeZone: \"UTC\"\r\n-        });\r\n-\r\n-    return {\r\n-        ni,\r\n-        normalDay,\r\n-        cycleDays,\r\n-        payments\r\n-    };\r\n-}\r\n"
                },
                {
                    "date": 1768757122136,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,169 +1,154 @@\n // src/lib/pensionEngine.ts\r\n \r\n export type Payment = {\r\n-  paid: string;        // YYYY-MM-DD (UTC)\r\n-  early: boolean;\r\n-  holidays?: string[];\r\n+    paid: string;        // YYYY-MM-DD (UTC)\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n };\r\n \r\n export type PensionResult = {\r\n-  ni: string;\r\n-  normalDay: string;\r\n-  cycleDays: number;\r\n-  payments: Payment[];\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n };\r\n \r\n-/* ------------------------------------------------------------\r\n-   VERIFIED DWP ANCHOR\r\n------------------------------------------------------------- */\r\n+// VERIFIED DWP GRID ANCHOR\r\n+const BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\n+const BASE_NI = \"00A\";\r\n \r\n-// Known real payment:\r\n-// NI 29B → Tuesday 6 Jan 2026\r\n-const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n-const BASE_NI = \"29B\";\r\n-\r\n /* ------------------------------------------------------------\r\n    DATE HELPERS (UTC SAFE)\r\n ------------------------------------------------------------ */\r\n \r\n function addDaysUTC(date: Date, days: number): Date {\r\n-  const d = new Date(date);\r\n-  d.setUTCDate(d.getUTCDate() + days);\r\n-  return d;\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n }\r\n \r\n function formatISO(date: Date): string {\r\n-  return date.toISOString().slice(0, 10);\r\n+    return date.toISOString().slice(0, 10);\r\n }\r\n \r\n-function isWeekendUTC(d: Date): boolean {\r\n-  const day = d.getUTCDay();\r\n-  return day === 0 || day === 6;\r\n-}\r\n-\r\n /* ------------------------------------------------------------\r\n    NI GRID LOGIC (OFFSETS IN WEEKS)\r\n ------------------------------------------------------------ */\r\n \r\n function parseNI(ni: string): { digits: number; letter: string } {\r\n-  const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-  if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n-  return { digits: +m[1], letter: m[2] };\r\n+    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+    return { digits: +m[1], letter: m[2] };\r\n }\r\n \r\n function rowFromDigits(d: number): number {\r\n-  if (d <= 19) return 0;\r\n-  if (d <= 39) return 1;\r\n-  if (d <= 59) return 2;\r\n-  if (d <= 79) return 3;\r\n-  return 4;\r\n+    if (d <= 19) return 0;\r\n+    if (d <= 39) return 1;\r\n+    if (d <= 59) return 2;\r\n+    if (d <= 79) return 3;\r\n+    return 4;\r\n }\r\n \r\n+\r\n function niOffsetDays(ni: string): number {\r\n-  const base = parseNI(BASE_NI);\r\n-  const target = parseNI(ni);\r\n+    const base = parseNI(BASE_NI);\r\n+    const target = parseNI(ni);\r\n \r\n-  const rowOffset =\r\n-    (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n+    const rowOffset =\r\n+        rowFromDigits(target.digits) - rowFromDigits(base.digits);\r\n \r\n-  const colOffset =\r\n-    (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+    const colOffset =\r\n+        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n \r\n-  return rowOffset + colOffset;\r\n+    return rowOffset + colOffset;\r\n }\r\n \r\n-/* ------------------------------------------------------------\r\n-   BANK HOLIDAY ADJUSTMENT (EARLY ONLY)\r\n------------------------------------------------------------- */\r\n \r\n function adjustForNonWorkingDays(\r\n-  date: Date,\r\n-  bankHolidays: Record<string, string>\r\n+    date: Date,\r\n+    bankHolidays: Record<string, string>\r\n ): { date: Date; early: boolean; holidays: string[] } {\r\n \r\n-  let d = new Date(date);\r\n-  const reasons: string[] = [];\r\n+    let d = new Date(date);\r\n+    const holidays: string[] = [];\r\n+    let early = false;\r\n \r\n-  while (true) {\r\n-    const iso = formatISO(d);\r\n+    while (true) {\r\n+        const iso = d.toISOString().slice(0, 10);\r\n+        const dow = d.getUTCDay();\r\n \r\n-    if (isWeekendUTC(d)) {\r\n-      reasons.push(\"Weekend\");\r\n-      d = addDaysUTC(d, -1);\r\n-      continue;\r\n-    }\r\n+        const isWeekend = dow === 0 || dow === 6;\r\n+        const isHoliday = !!bankHolidays[iso];\r\n \r\n-    if (bankHolidays[iso]) {\r\n-      reasons.push(bankHolidays[iso]);\r\n-      d = addDaysUTC(d, -1);\r\n-      continue;\r\n+        if (!isWeekend && !isHoliday) break;\r\n+\r\n+        early = true;\r\n+        if (isHoliday) holidays.push(bankHolidays[iso]);\r\n+\r\n+        d.setUTCDate(d.getUTCDate() - 1);\r\n     }\r\n \r\n-    break;\r\n-  }\r\n-\r\n-  return {\r\n-    date: d,\r\n-    early: d.getTime() !== date.getTime(),\r\n-    holidays: reasons\r\n-  };\r\n+    return { date: d, early, holidays };\r\n }\r\n \r\n+\r\n /* ------------------------------------------------------------\r\n-   MAIN ENGINE (LOCKED)\r\n+   MAIN ENGINE\r\n ------------------------------------------------------------ */\r\n \r\n+\r\n export function generatePayments(\r\n-  ni: string,\r\n-  startYear: number,\r\n-  endYear: number,\r\n-  cycleDays: number = 28,\r\n-  bankHolidays: Record<string, string>\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28,\r\n+    bankHolidays: Record<string, string> = {}\r\n ): PensionResult {\r\n \r\n-  if (![7, 14, 28].includes(cycleDays)) {\r\n-    throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-  }\r\n+    if (![7, 14, 28].includes(cycleDays)) {\r\n+        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+    }\r\n \r\n-  // 1️⃣ Anchor NI to real DWP grid\r\n-  let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n \r\n-  // 2️⃣ Rewind to cover requested range\r\n-  while (d.getUTCFullYear() > startYear) {\r\n-    d = addDaysUTC(d, -cycleDays);\r\n-  }\r\n+    const startBoundary = new Date(Date.UTC(startYear, 0, 1));\r\n+    const endBoundary = new Date(Date.UTC(endYear + 1, 0, 1));\r\n \r\n-  // 3️⃣ Move forward into range\r\n-  while (d.getUTCFullYear() < startYear) {\r\n-    d = addDaysUTC(d, cycleDays);\r\n-  }\r\n+    // 2️⃣ Rewind until before the start boundary\r\n+    while (d >= startBoundary) {\r\n+        d = addDaysUTC(d, -cycleDays);\r\n+    }\r\n \r\n-  const payments: Payment[] = [];\r\n+    // 3️⃣ Move to first payment >= startBoundary\r\n+    do {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    } while (d < startBoundary);\r\n \r\n-  // 4️⃣ Collect payments\r\n-  while (d.getUTCFullYear() <= endYear) {\r\n-    const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n+    const payments: Payment[] = [];\r\n \r\n-    payments.push({\r\n-      paid: formatISO(adjusted.date),\r\n-      early: adjusted.early,\r\n-      holidays: adjusted.holidays.length ? adjusted.holidays : undefined\r\n-    });\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n+        //console.log(\"RAW\", formatISO(d), \"→ ADJ\", formatISO(adjusted.date));\r\n+        payments.push({\r\n+            paid: formatISO(adjusted.date),\r\n+            early: adjusted.early,\r\n+            holidays: adjusted.holidays\r\n+        });\r\n \r\n-    d = addDaysUTC(d, cycleDays);\r\n-  }\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    }\r\n \r\n-  // 5️⃣ Derive weekday name correctly\r\n-  const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n-    .toLocaleDateString(\"en-GB\", {\r\n-      weekday: \"long\",\r\n-      timeZone: \"UTC\"\r\n-    });\r\n+    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n+    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+        .toLocaleDateString(\"en-GB\", {\r\n+            weekday: \"long\",\r\n+            timeZone: \"UTC\"\r\n+        });\r\n \r\n-  return {\r\n-    ni,\r\n-    normalDay,\r\n-    cycleDays,\r\n-    payments\r\n-  };\r\n+    return {\r\n+        ni,\r\n+        normalDay,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n }\r\n"
                },
                {
                    "date": 1768769958797,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,154 +1,165 @@\n // src/lib/pensionEngine.ts\r\n \r\n export type Payment = {\r\n-    paid: string;        // YYYY-MM-DD (UTC)\r\n-    early: boolean;\r\n-    holidays?: string[];\r\n+  paid: string;        // YYYY-MM-DD (UTC)\r\n+  early: boolean;\r\n+  holidays?: string[];\r\n };\r\n \r\n export type PensionResult = {\r\n-    ni: string;\r\n-    normalDay: string;\r\n-    cycleDays: number;\r\n-    payments: Payment[];\r\n+  ni: string;\r\n+  normalDay: string;\r\n+  cycleDays: number;\r\n+  payments: Payment[];\r\n };\r\n \r\n-// VERIFIED DWP GRID ANCHOR\r\n-const BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\n-const BASE_NI = \"00A\";\r\n+/* ------------------------------------------------------------\r\n+   VERIFIED DWP ANCHOR\r\n+------------------------------------------------------------ */\r\n \r\n+// Known real payment:\r\n+// NI 29B → Tuesday 6 Jan 2026\r\n+const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n+const BASE_NI = \"29B\";\r\n+\r\n /* ------------------------------------------------------------\r\n    DATE HELPERS (UTC SAFE)\r\n ------------------------------------------------------------ */\r\n \r\n function addDaysUTC(date: Date, days: number): Date {\r\n-    const d = new Date(date);\r\n-    d.setUTCDate(d.getUTCDate() + days);\r\n-    return d;\r\n+  const d = new Date(date);\r\n+  d.setUTCDate(d.getUTCDate() + days);\r\n+  return d;\r\n }\r\n \r\n function formatISO(date: Date): string {\r\n-    return date.toISOString().slice(0, 10);\r\n+  return date.toISOString().slice(0, 10);\r\n }\r\n \r\n+function isWeekendUTC(d: Date): boolean {\r\n+  const day = d.getUTCDay();\r\n+  return day === 0 || day === 6;\r\n+}\r\n+\r\n /* ------------------------------------------------------------\r\n    NI GRID LOGIC (OFFSETS IN WEEKS)\r\n ------------------------------------------------------------ */\r\n \r\n function parseNI(ni: string): { digits: number; letter: string } {\r\n-    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n-    return { digits: +m[1], letter: m[2] };\r\n+  const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+  if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+  return { digits: +m[1], letter: m[2] };\r\n }\r\n \r\n function rowFromDigits(d: number): number {\r\n-    if (d <= 19) return 0;\r\n-    if (d <= 39) return 1;\r\n-    if (d <= 59) return 2;\r\n-    if (d <= 79) return 3;\r\n-    return 4;\r\n+  if (d <= 19) return 0;\r\n+  if (d <= 39) return 1;\r\n+  if (d <= 59) return 2;\r\n+  if (d <= 79) return 3;\r\n+  return 4;\r\n }\r\n \r\n-\r\n function niOffsetDays(ni: string): number {\r\n-    const base = parseNI(BASE_NI);\r\n-    const target = parseNI(ni);\r\n+  const base = parseNI(BASE_NI);\r\n+  const target = parseNI(ni);\r\n \r\n-    const rowOffset =\r\n-        rowFromDigits(target.digits) - rowFromDigits(base.digits);\r\n+  const rowOffset =\r\n+    (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n \r\n-    const colOffset =\r\n-        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+  const colOffset =\r\n+    (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n \r\n-    return rowOffset + colOffset;\r\n+  return rowOffset + colOffset;\r\n }\r\n \r\n+/* ------------------------------------------------------------\r\n+   BANK HOLIDAY ADJUSTMENT (EARLY ONLY)\r\n+------------------------------------------------------------ */\r\n \r\n function adjustForNonWorkingDays(\r\n-    date: Date,\r\n-    bankHolidays: Record<string, string>\r\n+  date: Date,\r\n+  bankHolidays: Record<string, string>\r\n ): { date: Date; early: boolean; holidays: string[] } {\r\n \r\n-    let d = new Date(date);\r\n-    const holidays: string[] = [];\r\n-    let early = false;\r\n+  let d = new Date(date);\r\n+  const reasons: string[] = [];\r\n \r\n-    while (true) {\r\n-        const iso = d.toISOString().slice(0, 10);\r\n-        const dow = d.getUTCDay();\r\n+  while (true) {\r\n+    const iso = formatISO(d);\r\n \r\n-        const isWeekend = dow === 0 || dow === 6;\r\n-        const isHoliday = !!bankHolidays[iso];\r\n+    if (isWeekendUTC(d)) {\r\n+      reasons.push(\"Weekend\");\r\n+      d = addDaysUTC(d, -1);\r\n+      continue;\r\n+    }\r\n \r\n-        if (!isWeekend && !isHoliday) break;\r\n+    if (bankHolidays[iso]) {\r\n+      reasons.push(bankHolidays[iso]);\r\n+      d = addDaysUTC(d, -1);\r\n+      continue;\r\n+    }\r\n \r\n-        early = true;\r\n-        if (isHoliday) holidays.push(bankHolidays[iso]);\r\n+    break;\r\n+  }\r\n \r\n-        d.setUTCDate(d.getUTCDate() - 1);\r\n-    }\r\n-\r\n-    return { date: d, early, holidays };\r\n+  return {\r\n+    date: d,\r\n+    early: d.getTime() !== date.getTime(),\r\n+    holidays: reasons\r\n+  };\r\n }\r\n \r\n-\r\n /* ------------------------------------------------------------\r\n-   MAIN ENGINE\r\n+   MAIN ENGINE (LOCKED)\r\n ------------------------------------------------------------ */\r\n \r\n-\r\n export function generatePayments(\r\n-    ni: string,\r\n-    startYear: number,\r\n-    endYear: number,\r\n-    cycleDays: number = 28,\r\n-    bankHolidays: Record<string, string> = {}\r\n+  ni: string,\r\n+  startYear: number,\r\n+  endYear: number,\r\n+  cycleDays: number = 28\r\n ): PensionResult {\r\n \r\n-    if (![7, 14, 28].includes(cycleDays)) {\r\n-        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-    }\r\n+  if (![7, 14, 28].includes(cycleDays)) {\r\n+    throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+  }\r\n \r\n-    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+  // 1️⃣ Anchor this NI onto the real DWP grid\r\n+  let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n \r\n-    const startBoundary = new Date(Date.UTC(startYear, 0, 1));\r\n-    const endBoundary = new Date(Date.UTC(endYear + 1, 0, 1));\r\n+  // 2️⃣ Rewind until we are safely BEFORE the range\r\n+  while (d.getUTCFullYear() >= startYear) {\r\n+    d = addDaysUTC(d, -cycleDays);\r\n+  }\r\n \r\n-    // 2️⃣ Rewind until before the start boundary\r\n-    while (d >= startBoundary) {\r\n-        d = addDaysUTC(d, -cycleDays);\r\n-    }\r\n+  const payments: Payment[] = [];\r\n \r\n-    // 3️⃣ Move to first payment >= startBoundary\r\n-    do {\r\n-        d = addDaysUTC(d, cycleDays);\r\n-    } while (d < startBoundary);\r\n+  // 3️⃣ Move forward and collect only in-range payments\r\n+  while (true) {\r\n+    d = addDaysUTC(d, cycleDays);\r\n \r\n-    const payments: Payment[] = [];\r\n+    const year = d.getUTCFullYear();\r\n+    if (year > endYear) break;\r\n \r\n-    while (d.getUTCFullYear() <= endYear) {\r\n-        const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n-        //console.log(\"RAW\", formatISO(d), \"→ ADJ\", formatISO(adjusted.date));\r\n-        payments.push({\r\n-            paid: formatISO(adjusted.date),\r\n-            early: adjusted.early,\r\n-            holidays: adjusted.holidays\r\n-        });\r\n-\r\n-        d = addDaysUTC(d, cycleDays);\r\n+    if (year >= startYear) {\r\n+      payments.push({\r\n+        paid: formatISO(d),\r\n+        early: false\r\n+      });\r\n     }\r\n+  }\r\n \r\n-    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n-    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n-        .toLocaleDateString(\"en-GB\", {\r\n-            weekday: \"long\",\r\n-            timeZone: \"UTC\"\r\n-        });\r\n+  // 4️⃣ Weekday comes ONLY from the anchored grid\r\n+  const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+    .toLocaleDateString(\"en-GB\", {\r\n+      weekday: \"long\",\r\n+      timeZone: \"UTC\"\r\n+    });\r\n \r\n-    return {\r\n-        ni,\r\n-        normalDay,\r\n-        cycleDays,\r\n-        payments\r\n-    };\r\n+  return {\r\n+    ni,\r\n+    normalDay,\r\n+    cycleDays,\r\n+    payments\r\n+  };\r\n }\r\n"
                },
                {
                    "date": 1768770004481,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,165 +1,158 @@\n // src/lib/pensionEngine.ts\r\n \r\n export type Payment = {\r\n-  paid: string;        // YYYY-MM-DD (UTC)\r\n-  early: boolean;\r\n-  holidays?: string[];\r\n+    paid: string;        // YYYY-MM-DD (UTC)\r\n+    early: boolean;\r\n+    holidays?: string[];\r\n };\r\n \r\n export type PensionResult = {\r\n-  ni: string;\r\n-  normalDay: string;\r\n-  cycleDays: number;\r\n-  payments: Payment[];\r\n+    ni: string;\r\n+    normalDay: string;\r\n+    cycleDays: number;\r\n+    payments: Payment[];\r\n };\r\n \r\n-/* ------------------------------------------------------------\r\n-   VERIFIED DWP ANCHOR\r\n------------------------------------------------------------- */\r\n+// VERIFIED DWP GRID ANCHOR\r\n+const BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\n+const BASE_NI = \"00A\";\r\n \r\n-// Known real payment:\r\n-// NI 29B → Tuesday 6 Jan 2026\r\n-const BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\n-const BASE_NI = \"29B\";\r\n-\r\n /* ------------------------------------------------------------\r\n    DATE HELPERS (UTC SAFE)\r\n ------------------------------------------------------------ */\r\n \r\n function addDaysUTC(date: Date, days: number): Date {\r\n-  const d = new Date(date);\r\n-  d.setUTCDate(d.getUTCDate() + days);\r\n-  return d;\r\n+    const d = new Date(date);\r\n+    d.setUTCDate(d.getUTCDate() + days);\r\n+    return d;\r\n }\r\n \r\n function formatISO(date: Date): string {\r\n-  return date.toISOString().slice(0, 10);\r\n+    return date.toISOString().slice(0, 10);\r\n }\r\n \r\n function isWeekendUTC(d: Date): boolean {\r\n   const day = d.getUTCDay();\r\n   return day === 0 || day === 6;\r\n }\r\n-\r\n /* ------------------------------------------------------------\r\n    NI GRID LOGIC (OFFSETS IN WEEKS)\r\n ------------------------------------------------------------ */\r\n \r\n function parseNI(ni: string): { digits: number; letter: string } {\r\n-  const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n-  if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n-  return { digits: +m[1], letter: m[2] };\r\n+    const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n+    if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n+    return { digits: +m[1], letter: m[2] };\r\n }\r\n \r\n function rowFromDigits(d: number): number {\r\n-  if (d <= 19) return 0;\r\n-  if (d <= 39) return 1;\r\n-  if (d <= 59) return 2;\r\n-  if (d <= 79) return 3;\r\n-  return 4;\r\n+    if (d <= 19) return 0;\r\n+    if (d <= 39) return 1;\r\n+    if (d <= 59) return 2;\r\n+    if (d <= 79) return 3;\r\n+    return 4;\r\n }\r\n \r\n+\r\n function niOffsetDays(ni: string): number {\r\n-  const base = parseNI(BASE_NI);\r\n-  const target = parseNI(ni);\r\n+    const base = parseNI(BASE_NI);\r\n+    const target = parseNI(ni);\r\n \r\n-  const rowOffset =\r\n-    (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n+    const rowOffset =\r\n+        rowFromDigits(target.digits) - rowFromDigits(base.digits);\r\n \r\n-  const colOffset =\r\n-    (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n+    const colOffset =\r\n+        (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n \r\n-  return rowOffset + colOffset;\r\n+    return rowOffset + colOffset;\r\n }\r\n \r\n-/* ------------------------------------------------------------\r\n-   BANK HOLIDAY ADJUSTMENT (EARLY ONLY)\r\n------------------------------------------------------------- */\r\n \r\n function adjustForNonWorkingDays(\r\n-  date: Date,\r\n-  bankHolidays: Record<string, string>\r\n+    date: Date,\r\n+    bankHolidays: Record<string, string>\r\n ): { date: Date; early: boolean; holidays: string[] } {\r\n \r\n-  let d = new Date(date);\r\n-  const reasons: string[] = [];\r\n+    let d = new Date(date);\r\n+    const holidays: string[] = [];\r\n+    let early = false;\r\n \r\n-  while (true) {\r\n-    const iso = formatISO(d);\r\n+    while (true) {\r\n+        const iso = d.toISOString().slice(0, 10);\r\n+        const dow = d.getUTCDay();\r\n \r\n-    if (isWeekendUTC(d)) {\r\n-      reasons.push(\"Weekend\");\r\n-      d = addDaysUTC(d, -1);\r\n-      continue;\r\n-    }\r\n+        const isWeekend = dow === 0 || dow === 6;\r\n+        const isHoliday = !!bankHolidays[iso];\r\n \r\n-    if (bankHolidays[iso]) {\r\n-      reasons.push(bankHolidays[iso]);\r\n-      d = addDaysUTC(d, -1);\r\n-      continue;\r\n+        if (!isWeekend && !isHoliday) break;\r\n+\r\n+        early = true;\r\n+        if (isHoliday) holidays.push(bankHolidays[iso]);\r\n+\r\n+        d.setUTCDate(d.getUTCDate() - 1);\r\n     }\r\n \r\n-    break;\r\n-  }\r\n-\r\n-  return {\r\n-    date: d,\r\n-    early: d.getTime() !== date.getTime(),\r\n-    holidays: reasons\r\n-  };\r\n+    return { date: d, early, holidays };\r\n }\r\n \r\n+\r\n /* ------------------------------------------------------------\r\n-   MAIN ENGINE (LOCKED)\r\n+   MAIN ENGINE\r\n ------------------------------------------------------------ */\r\n \r\n+\r\n export function generatePayments(\r\n-  ni: string,\r\n-  startYear: number,\r\n-  endYear: number,\r\n-  cycleDays: number = 28\r\n+    ni: string,\r\n+    startYear: number,\r\n+    endYear: number,\r\n+    cycleDays: number = 28,\r\n+    bankHolidays: Record<string, string> = {}\r\n ): PensionResult {\r\n \r\n-  if (![7, 14, 28].includes(cycleDays)) {\r\n-    throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n-  }\r\n+    if (![7, 14, 28].includes(cycleDays)) {\r\n+        throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n+    }\r\n \r\n-  // 1️⃣ Anchor this NI onto the real DWP grid\r\n-  let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n+    let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n \r\n-  // 2️⃣ Rewind until we are safely BEFORE the range\r\n-  while (d.getUTCFullYear() >= startYear) {\r\n-    d = addDaysUTC(d, -cycleDays);\r\n-  }\r\n+    const startBoundary = new Date(Date.UTC(startYear, 0, 1));\r\n+    const endBoundary = new Date(Date.UTC(endYear + 1, 0, 1));\r\n \r\n-  const payments: Payment[] = [];\r\n+    // 2️⃣ Rewind until before the start boundary\r\n+    while (d >= startBoundary) {\r\n+        d = addDaysUTC(d, -cycleDays);\r\n+    }\r\n \r\n-  // 3️⃣ Move forward and collect only in-range payments\r\n-  while (true) {\r\n-    d = addDaysUTC(d, cycleDays);\r\n+    // 3️⃣ Move to first payment >= startBoundary\r\n+    do {\r\n+        d = addDaysUTC(d, cycleDays);\r\n+    } while (d < startBoundary);\r\n \r\n-    const year = d.getUTCFullYear();\r\n-    if (year > endYear) break;\r\n+    const payments: Payment[] = [];\r\n \r\n-    if (year >= startYear) {\r\n-      payments.push({\r\n-        paid: formatISO(d),\r\n-        early: false\r\n-      });\r\n+    while (d.getUTCFullYear() <= endYear) {\r\n+        const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n+        //console.log(\"RAW\", formatISO(d), \"→ ADJ\", formatISO(adjusted.date));\r\n+        payments.push({\r\n+            paid: formatISO(adjusted.date),\r\n+            early: adjusted.early,\r\n+            holidays: adjusted.holidays\r\n+        });\r\n+\r\n+        d = addDaysUTC(d, cycleDays);\r\n     }\r\n-  }\r\n \r\n-  // 4️⃣ Weekday comes ONLY from the anchored grid\r\n-  const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n-    .toLocaleDateString(\"en-GB\", {\r\n-      weekday: \"long\",\r\n-      timeZone: \"UTC\"\r\n-    });\r\n+    // 5️⃣ Derive weekday from THIS NI (not base NI)\r\n+    const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n+        .toLocaleDateString(\"en-GB\", {\r\n+            weekday: \"long\",\r\n+            timeZone: \"UTC\"\r\n+        });\r\n \r\n-  return {\r\n-    ni,\r\n-    normalDay,\r\n-    cycleDays,\r\n-    payments\r\n-  };\r\n+    return {\r\n+        ni,\r\n+        normalDay,\r\n+        cycleDays,\r\n+        payments\r\n+    };\r\n }\r\n"
                }
            ],
            "date": 1768745725760,
            "name": "Commit-0",
            "content": "// src/lib/pensionEngine.ts\r\n\r\nexport type Payment = {\r\n  paid: string;        // YYYY-MM-DD\r\n  early: boolean;\r\n  holidays?: string[];\r\n};\r\n\r\nexport type PensionResult = {\r\n  ni: string;\r\n  normalDay: string;\r\n  cycleDays: number;\r\n  payments: Payment[];\r\n  bankHolidays?: Record<string, string>;\r\n};\r\n\r\nexport function generatePayments(\r\n  ni: string,\r\n  startYear: number,\r\n  endYear: number,\r\n  cycleDays: number\r\n): PensionResult {\r\n  return {\r\n    ni,\r\n    normalDay: 'Tuesday',\r\n    cycleDays,\r\n    payments: []\r\n  };\r\n}\r\n"
        }
    ]
}