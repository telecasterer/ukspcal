{
    "sourceFile": "frontend/src/gas/scripts.html",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1768898433257,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1768898433257,
            "name": "Commit-0",
            "content": "<script>\r\n \r\nconst helpBtn = document.getElementById(\"helpBtn\");\r\nconst helpModal = document.getElementById(\"helpModal\");\r\nconst helpClose = document.getElementById(\"closeHelp\");\r\n\r\n/* ============================================================\r\n   APPLICATION STATE (STEP 1)\r\n============================================================ */\r\nvar appState = {\r\n  raw: null,     // replaces lastData\r\n  model: null\r\n};\r\n\r\n(function () {\r\n  if (!/Mobi|Android/i.test(navigator.userAgent)) return;\r\n\r\n  const box = document.createElement(\"pre\");\r\n  box.style.cssText = `\r\n    position:fixed;\r\n    bottom:0;\r\n    left:0;\r\n    right:0;\r\n    max-height:40%;\r\n    background:#000;\r\n    color:#0f0;\r\n    font-size:11px;\r\n    overflow:auto;\r\n    padding:6px;\r\n    z-index:9999;\r\n  `;\r\n  document.body.appendChild(box);\r\n\r\n  const log = console.log;\r\n  console.log = function (...args) {\r\n    box.textContent += args.join(\" \") + \"\\n\";\r\n    log.apply(console, args);\r\n  };\r\n})();\r\n\r\nfunction isMobileViewport() {\r\n  if (window.visualViewport) {\r\n    return window.visualViewport.width <= 480;\r\n  }\r\n  return Math.min(screen.width, window.innerWidth) <= 480;\r\n}\r\n\r\n\r\nconsole.log(\"Viewport width:\", window.innerWidth);\r\nconsole.log(\"isMobileViewport:\", isMobileViewport());\r\n\r\nfunction applyResponsiveClass() {\r\n  document.body.classList.toggle(\"is-mobile\", isMobileViewport());\r\n}\r\n\r\n// Run immediately and on resize / zoom\r\napplyResponsiveClass();\r\nwindow.addEventListener(\"resize\", applyResponsiveClass);\r\nif (window.visualViewport) {\r\n  window.visualViewport.addEventListener(\"resize\", applyResponsiveClass);\r\n}\r\n\r\n\r\nhelpBtn.addEventListener(\"click\", () => {\r\n  helpModal.classList.remove(\"hidden\");\r\n});\r\n\r\nhelpClose.addEventListener(\"click\", () => {\r\n  helpModal.classList.add(\"hidden\");\r\n});\r\n\r\nhelpModal.addEventListener(\"click\", (e) => {\r\n  if (e.target === helpModal) {\r\n    helpModal.classList.add(\"hidden\");\r\n  }\r\n});\r\n\r\ndocument.addEventListener(\"keydown\", (e) => {\r\n  if (e.key === \"Escape\" && !helpModal.classList.contains(\"hidden\")) {\r\n    helpModal.classList.add(\"hidden\");\r\n  }\r\n});\r\n\r\n/* ============================================================\r\n   METADATA / STATUS\r\n============================================================ */\r\ngoogle.script.run.withSuccessHandler(meta => {\r\n  if (!meta || !meta.version) return;\r\n\r\n  const about = document.getElementById(\"aboutContent\");\r\nif (about) {\r\n  about.innerHTML =\r\n    `Version: v${meta.version} · ${new Date(meta.deployedAt).toLocaleString()} · ${meta.comment}`;\r\n}\r\n\r\n}).getAppMetadata();\r\n\r\nfunction message(text) {\r\n  document.getElementById(\"status\").textContent = text || \"\";\r\n}\r\n\r\n/* ============================================================\r\n   DEFAULT YEARS\r\n============================================================ */\r\n(function setDefaultYears() {\r\n  var start = document.getElementById(\"startYear\");\r\n  var end = document.getElementById(\"endYear\");\r\n  var y = new Date().getFullYear();\r\n\r\n  start.value = y;\r\n  end.value = y + 1;\r\n\r\n  start.addEventListener(\"change\", function () {\r\n    var sy = parseInt(start.value, 10);\r\n    if (!isNaN(sy)) end.value = sy + 1;\r\n  });\r\n})();\r\n\r\n\r\n/* ============================================================\r\n   DATE FORMATTING\r\n============================================================ */\r\nfunction formatDate(iso, fmt) {\r\n  var p = iso.split(\"-\").map(Number);\r\n  var y = p[0], m = p[1], d = p[2];\r\n  var date = new Date(Date.UTC(y, m - 1, d));\r\n\r\n  var days = [\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"];\r\n  var months = [\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"];\r\n\r\n  if (fmt === \"slash\") return String(d).padStart(2,\"0\") + \"/\" + String(m).padStart(2,\"0\") + \"/\" + y;\r\n  if (fmt === \"medium\") return d + \" \" + months[m - 1] + \" \" + y;\r\n  if (fmt === \"long\") return days[date.getUTCDay()] + \" \" + d + \" \" + months[m - 1] + \" \" + y;\r\n  return iso;\r\n}\r\n\r\n/* ============================================================\r\n   PREVIEW\r\n============================================================ */\r\n\r\nfunction regenerateIfReady() {\r\n  var ni = document.getElementById(\"ni\").value.trim();\r\n  var sy = parseInt(startYear.value, 10);\r\n  var ey = parseInt(endYear.value, 10);\r\n\r\n  if (!ni || isNaN(sy) || isNaN(ey)) return;\r\n\r\n  renderEmptyState(\"\");\r\n  appState.raw = null;\r\n  appState.model = null;\r\n  message(\"\");\r\n  \r\n  const cycleDays = parseInt(document.getElementById(\"cycleDays\").value, 10);\r\n\r\n  google.script.run\r\n  .withSuccessHandler(handlePreviewData)\r\n  .withFailureHandler(e => message(e?.message || e))\r\n  .generatePayments(ni, sy, ey, cycleDays);\r\n\r\n  }\r\n\r\n[\"ni\",\"startYear\",\"endYear\", \"cycleDays\"].forEach(function (id) {\r\n  var el = document.getElementById(id);\r\n  if (!el) return;\r\n  el.addEventListener(\"change\", regenerateIfReady);\r\n});\r\n\r\nfunction renderEmptyState(text) {\r\n  var output = document.getElementById(\"outputContent\");\r\n  output.innerHTML =\r\n    '<div class=\"empty-state\">' +\r\n    text +\r\n    '</div>';\r\n}\r\n\r\n\r\nfunction updateCalendarVisibility() {\r\n  const cal = document.querySelector(\".calendar-inline\");\r\n  if (!cal) return;\r\n\r\n  cal.classList.toggle(\r\n    \"hide-weekends\",\r\n    !document.getElementById(\"showWeekends\").checked\r\n  );\r\n\r\n  cal.classList.toggle(\r\n    \"hide-bank-holidays\",\r\n    !document.getElementById(\"showBankHolidays\").checked\r\n  );\r\n}\r\n\r\n[\"showWeekends\", \"showBankHolidays\"].forEach(id => {\r\n  const el = document.getElementById(id);\r\n  el.addEventListener(\"change\", updateCalendarVisibility);\r\n});\r\n\r\n/* ============================================================\r\n   List + INFO\r\n============================================================ */\r\nfunction handlePreviewData(data) {\r\n  appState.raw = data;\r\n  appState.model = buildCalendarModel(data, getCalendarOptions());\r\n  appState.model.meta.eventTitle =\r\n  document.getElementById(\"eventTitle\")?.value || \"UK State Pension\";\r\n\r\n  appState.model.meta.eventColor =\r\n  document.getElementById(\"eventColor\")?.value || \"\";\r\n\r\n  appState.model.meta.earlyColor =\r\n  document.getElementById(\"earlyColor\")?.value || \"\";\r\n// ---- END BLOCK ----\r\n\r\n  renderInfoPanel(data);\r\n  setView(currentView);\r\n}\r\n\r\n/* ============================================================\r\n   CALENDAR OPTIONS\r\n============================================================ */\r\nfunction getCalendarOptions() {\r\n  return {\r\n    showWeekends: document.getElementById(\"showWeekends\").checked,\r\n    showBankHolidays: document.getElementById(\"showBankHolidays\").checked\r\n  };\r\n}\r\n\r\n/* ============================================================\r\n   CALENDAR MODEL\r\n============================================================ */\r\nfunction buildCalendarModel(lastData, options) {\r\n  options = options || {};\r\n  var showWeekends = options.showWeekends !== false;\r\n  var showBankHolidays = options.showBankHolidays !== false;\r\n\r\n  var bankHolidays = {};\r\n  if (showBankHolidays && lastData.bankHolidays) {\r\n    Object.keys(lastData.bankHolidays).forEach(function (d) {\r\n      bankHolidays[d] = lastData.bankHolidays[d];\r\n    });\r\n  }\r\n\r\n  var paymentsByMonth = {};\r\n  lastData.payments.forEach(function (p) {\r\n  var parts = p.paid.split(\"-\");\r\n  var key = parts[0] + \"-\" + parts[1];\r\n  var day = Number(parts[2]);\r\n  if (!paymentsByMonth[key]) paymentsByMonth[key] = {};\r\n  \r\n  paymentsByMonth[key][day] = {\r\n    early: p.early,\r\n    holidays: p.holidays || []\r\n  };\r\n  \r\n  });\r\n  var months = [];\r\n  var monthKeys = Object.keys(paymentsByMonth).sort();\r\n  var holidaySymbols = [\"*\", \"+\", \"#\", \"~\", \"^\"];\r\n\r\n  monthKeys.forEach(function (key) {\r\n    var parts = key.split(\"-\");\r\n    var year = Number(parts[0]);\r\n    var month = Number(parts[1]);\r\n    var first = new Date(Date.UTC(year, month - 1, 1));\r\n    var daysInMonth = new Date(Date.UTC(year, month, 0)).getUTCDate();\r\n    var startOffset = (first.getUTCDay() + 6) % 7;\r\n\r\n    var days = [];\r\n    var paymentFootnotes = [];\r\n    var holidayFootnotes = [];\r\n\r\n    for (var d = 1; d <= daysInMonth; d++) {\r\n      var iso =\r\n        year + \"-\" +\r\n        String(month).padStart(2,\"0\") + \"-\" +\r\n        String(d).padStart(2,\"0\");\r\n\r\n      var dow = (startOffset + d - 1) % 7;\r\n      var isWeekend = dow >= 5;\r\n      var isBH = showBankHolidays && bankHolidays[iso];\r\n      var bhName = isBH ? bankHolidays[iso] : null;\r\n      var pay = paymentsByMonth[key][d];\r\n\r\n      var paymentIndex = null;\r\n      var holidaySymbol = null;\r\n      if (pay && pay.early) {\r\n        paymentIndex = paymentFootnotes.length + 1;\r\n\r\n        var note = \"Paid early\";\r\n        if (pay.holidays && pay.holidays.length) {\r\n          note += \" – \" + pay.holidays[0];\r\n        } else if (isBH && bhName) {\r\n          note += \" – \" + bhName;\r\n        }\r\n\r\n        paymentFootnotes.push(note);\r\n      }\r\n      \r\n      days.push({\r\n        day: d,\r\n        iso: iso,\r\n        isWeekend: isWeekend,\r\n        isBankHoliday: !!isBH,\r\n        isPayment: !!pay,\r\n        paymentFootnoteIndex: paymentIndex,\r\n        holidayFootnoteSymbol: holidaySymbol\r\n      });\r\n    }\r\n\r\n    months.push({\r\n      monthName: first.toLocaleString(\"en-GB\", { month:\"long\", year:\"numeric\", timeZone:\"UTC\" }),\r\n      startOffset: startOffset,\r\n      days: days,\r\n      paymentFootnotes: paymentFootnotes,\r\n      holidayFootnotes: holidayFootnotes\r\n    });\r\n  });\r\n  \r\n  return {\r\n    meta: {\r\n      ni: lastData.ni,\r\n      normalDay: lastData.normalDay,\r\n      cycleDays: lastData.cycleDays\r\n    },\r\n    months: months\r\n  };\r\n\r\n}\r\n\r\n\r\nfunction renderInfoPanel(data) {\r\n  const panel = document.getElementById(\"info-panel\");\r\n  if (!panel || !data) return;\r\n\r\n  const fmt = dateFormat.value;\r\n\r\n  const payments = data.payments || [];\r\n  const count = payments.length;\r\n\r\n  if (!count) {\r\n    panel.innerHTML =\r\n      `<div class=\"info-placeholder\">\r\n        No payments fall within the selected period.\r\n       </div>`;\r\n    return;\r\n  }\r\n\r\n  const first = payments[0].paid;\r\n  const last = payments[payments.length - 1].paid;\r\n  const earlyCount = payments.filter(p => p.early).length;\r\n\r\n  const cycleDays = data.cycleDays || 28;\r\n\r\n const cycleLabel = cycleDays === 28\r\n    ? \"Every 28 days (standard)\"\r\n    : `Every ${cycleDays} days`;\r\n\r\n  panel.innerHTML = `\r\n    <div>\r\n      <strong>Payment cycle:</strong> ${cycleLabel}<br>\r\n      <strong>Normal payment day:</strong> ${data.normalDay}<br>\r\n      <strong>Payments shown:</strong> ${count}<br>\r\n      <strong>Period:</strong>\r\n        ${formatDate(first, fmt)} – ${formatDate(last, fmt)}\r\n      ${earlyCount\r\n        ? `<br><strong>Early payments:</strong> ${earlyCount}`\r\n        : ``}\r\n    </div>\r\n  `;\r\n}\r\n\r\n/* ============================================================\r\n   CALENDAR INLINE RENDER (STEP 3)\r\n============================================================ */\r\n\r\nfunction renderCalendarInline() {\r\n  if (!appState.raw) return;\r\n\r\n  var output = document.getElementById(\"outputContent\");\r\n  output.innerHTML = \"\";\r\n\r\n  var options = getCalendarOptions();\r\n  var model = buildCalendarModel(appState.raw, options);\r\n  var monthsPerPage = isMobileViewport() ? 1 : 6;\r\n\r\n  var out = [];\r\n\r\n  out.push('<div class=\"calendar-inline\">');\r\n\r\n  for (var i = 0; i < model.months.length; i += monthsPerPage) {\r\n    out.push('<div class=\"page\">');\r\n\r\n    model.months.slice(i, i + monthsPerPage).forEach(function (month) {\r\n      out.push(\"<div class='month'>\");\r\n      out.push(\"<h3>\" + month.monthName + \"</h3>\");\r\n      out.push(buildCalendarLegend(options));\r\n\r\n      out.push(\"<table><tr>\");\r\n      [\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\",\"Sun\"].forEach(function (d) {\r\n        out.push(\"<th>\" + d + \"</th>\");\r\n      });\r\n      out.push(\"</tr><tr>\");\r\n\r\n      for (var k = 0; k < month.startOffset; k++) out.push(\"<td></td>\");\r\n\r\n      month.days.forEach(function (day, idx) {\r\n        var cls = [];\r\n        if (day.isWeekend && options.showWeekends) cls.push(\"weekend\");\r\n        if (day.isBankHoliday && options.showBankHolidays) cls.push(\"bank-holiday\");\r\n        if (day.isPayment) cls.push(\"pay\");\r\n\r\n        out.push(\"<td class='\" + cls.join(\" \") + \"'>\");\r\n        out.push(day.day);\r\n\r\n        if (day.paymentFootnoteIndex) {\r\n          out.push(\"<span class='fn'>\" + day.paymentFootnoteIndex + \"</span>\");\r\n        }\r\n        if (day.holidayFootnoteSymbol) {\r\n          out.push(\"<span class='fn'>\" + day.holidayFootnoteSymbol + \"</span>\");\r\n        }\r\n\r\n        out.push(\"</td>\");\r\n\r\n        if ((idx + month.startOffset + 1) % 7 === 0) out.push(\"</tr><tr>\");\r\n      });\r\n\r\n      out.push(\"</tr></table>\");\r\n\r\n      month.paymentFootnotes.forEach(function (t, n) {\r\n        out.push(\"<div class='footnotes'><sup>\" + (n + 1) + \"</sup> \" + t + \"</div>\");\r\n      });\r\n      month.holidayFootnotes.forEach(function (t) {\r\n        out.push(\"<div class='footnotes'><sup>*</sup> \" + t + \"</div>\");\r\n      });\r\n\r\n      out.push(\"</div>\");\r\n    });\r\n\r\n    out.push(\"</div>\");\r\n  }\r\n\r\n  out.push(\"</div>\");\r\n  output.innerHTML = out.join(\"\");\r\n}\r\n\r\n/* ============================================================\r\n   CALENDAR LEGEND\r\n============================================================ */\r\nfunction buildCalendarLegend(options) {\r\n  var h = [];\r\n  h.push('<div class=\"cal-legend\">');\r\n  h.push('<span class=\"legend-item\"><span class=\"legend-box legend-pay\"></span>Payment date</span>');\r\n  if (options.showBankHolidays) {\r\n    h.push('<span class=\"legend-item\"><span class=\"legend-box legend-holiday\"></span>Bank holiday</span>');\r\n  }\r\n  if (options.showWeekends) {\r\n    h.push('<span class=\"legend-item\"><span class=\"legend-box legend-weekend\"></span>Weekend</span>');\r\n  }\r\n  h.push('</div>');\r\n  return h.join(\"\");\r\n}\r\n\r\nfunction renderList() {\r\n  if (!appState.raw) return;\r\n\r\n  const output = document.getElementById(\"outputContent\");\r\n  output.innerHTML = \"\";\r\n\r\n  const fmt = document.getElementById(\"dateFormat\").value;\r\n\r\n  const ul = document.createElement(\"ul\");\r\n  ul.className = \"date-list\";\r\n\r\n  appState.raw.payments.forEach(p => {\r\n    let line = formatDate(p.paid, fmt);\r\n\r\n    if (p.early) {\r\n      const reason = p.holidays && p.holidays.length\r\n        ? p.holidays[0]\r\n        : \"bank holiday\";\r\n      line += ` (paid early – ${reason})`;\r\n    }\r\n\r\n    const li = document.createElement(\"li\");\r\n    li.textContent = line;\r\n    ul.appendChild(li);\r\n  });\r\n\r\n  output.appendChild(ul);\r\n}\r\n\r\n\r\nfunction renderCSVInline() {\r\n  if (!appState.model) return;\r\n\r\n  var output = document.getElementById(\"outputContent\");\r\n  var pre = document.createElement(\"pre\");\r\n  pre.textContent = buildCSVOutput(appState.model);\r\n\r\n  output.innerHTML = \"\";\r\n  output.appendChild(pre);\r\n}\r\n\r\nfunction renderICSInline() {\r\n  if (!appState.model) return;\r\n\r\n  var output = document.getElementById(\"outputContent\");\r\n  var pre = document.createElement(\"pre\");\r\n  pre.textContent = buildICSOutput(appState.model);\r\n\r\n  output.innerHTML = \"\";\r\n  output.appendChild(pre);\r\n}\r\n\r\n\r\nfunction printTable() {\r\n  if (!appState.raw) return;\r\n\r\n  var tableEl = document.querySelector(\"#output table\");\r\n  if (!tableEl) {\r\n    message(\"Nothing to print.\");\r\n    return;\r\n  }\r\n\r\n  var win = window.open(\"\", \"_blank\");\r\n  if (!win) {\r\n    message(\"Popup blocked. Please allow popups.\");\r\n    return;\r\n  }\r\n\r\n  win.document.write(\"<!DOCTYPE html><html><head><title>UK State Pension payments</title>\");\r\n\r\n  // reuse existing styles + minimal print tweaks\r\n  win.document.write(\"<style>\");\r\n  win.document.write(document.querySelector(\"style\").innerHTML);\r\n  win.document.write(`\r\n    body { background: #fff; padding: 1rem; }\r\n    .card, .view-bar, .help-icon { display: none; }\r\n    table { width: 100%; }\r\n  `);\r\n  win.document.write(\"</style>\");\r\n\r\n  win.document.write(\"</head><body>\");\r\n  win.document.write(tableEl.outerHTML);\r\n  win.document.write(\"</body></html>\");\r\n  win.document.close();\r\n\r\n  setTimeout(function () {\r\n    win.print();\r\n  }, 200);\r\n}\r\n\r\n/* ============================================================\r\n   PRINT CALENDAR\r\n============================================================ */\r\nfunction printCalendar() {\r\n   var CALENDAR_PRINT_CSS =\r\n  \"body{font-family:system-ui,sans-serif;padding:1rem;\" +\r\n  \"-webkit-print-color-adjust:exact;print-color-adjust:exact}\" +\r\n  \".page{display:grid;grid-template-columns:1fr 1fr;gap:.9rem;\" +\r\n  \"page-break-after:always}\" +\r\n  \"h3{margin:.2rem 0;font-size:.9rem}\" +\r\n  \"table{border-collapse:collapse;width:100%}\" +\r\n  \"th,td{border:1px solid #ccc;padding:.12rem;height:2.3rem;\" +\r\n  \"text-align:center;font-size:.68rem}\" +\r\n  \"th{background:#f1f5f9}\" +\r\n  \".weekend{background:#f3f4f6}\" +\r\n  \".bank-holiday{background:#fee2e2}\" +\r\n  \".pay{background:#dbeafe;font-weight:700}\" +\r\n  \".fn{font-size:.55rem;vertical-align:super;font-weight:700}\" +\r\n  \".footnotes{font-size:.6rem;margin-top:.25rem;color:#92400e}\" +\r\n  \".cal-legend{display:flex;gap:1rem;align-items:center;\" +\r\n  \"font-size:.8rem;color:#334155;margin:.75rem 0 1rem;flex-wrap:wrap}\" +\r\n  \".legend-item{display:inline-flex;align-items:center;gap:.35rem}\" +\r\n  \".legend-box{width:14px;height:14px;border-radius:4px;\" +\r\n  \"border:1px solid #cbd5e1}\" +\r\n  \".legend-pay{background:#e0f2fe}\" +\r\n  \".legend-holiday{background:#fde2e2}\" +\r\n  \".legend-weekend{background:#f1f5f9}\";\r\n  if (!appState.raw) return;\r\n\r\n  var win = window.open(\"\", \"_blank\");\r\n  if (!win) {\r\n    message(\"Popup blocked. Please allow popups.\");\r\n    return;\r\n  }\r\n\r\n  win.document.write(\"<html><head><title>UK State Pension calendar</title>\");\r\n  win.document.write(\"<style>\" + CALENDAR_PRINT_CSS + \"</style>\");\r\n  win.document.write(\"</head><body>\");\r\n  win.document.write(document.querySelector(\".calendar-inline\").outerHTML);\r\n  win.document.write(\"</body></html>\");\r\n  win.document.close();\r\n\r\n  setTimeout(function () { win.print(); }, 200);\r\n}\r\n\r\n/* ============================================================\r\n   VIEW SELECTION (STEP 2)\r\n============================================================ */\r\n\r\nvar currentView = \"calendar\";\r\n\r\nvar viewTabs = document.querySelectorAll(\".view-tab\");\r\nfor (var i = 0; i < viewTabs.length; i++) {\r\n  viewTabs[i].addEventListener(\"click\", function () {\r\n    var view = this.getAttribute(\"data-view\");\r\n    setView(view);\r\n  });\r\n}\r\n\r\nfunction updateViewControls(view) {\r\n  // Hide all view-specific controls\r\n  document.querySelectorAll(\".view-controls\").forEach(el => {\r\n    el.style.display = \"none\";\r\n  });\r\n\r\n  // Show controls for the active view\r\n  let selector = null;\r\n\r\n  if (view === \"calendar\") selector = \".view-calendar\";\r\n  if (view === \"list\" || view === \"csv\") selector = \".view-text\";\r\n  if (view === \"ics\") selector = \".view-ics\";\r\n\r\n  if (selector) {\r\n    const el = document.querySelector(selector);\r\n    if (el) el.style.display = \"block\";\r\n  }\r\n}\r\n\r\nfunction setView(view) {\r\n  currentView = view;\r\n\r\n  document.querySelectorAll(\".view-tab\").forEach(tab => {\r\n    const active = tab.dataset.view === view;\r\n    tab.classList.toggle(\"active\", active);\r\n    tab.setAttribute(\"aria-selected\", active);\r\n  });\r\n\r\n  updateViewControls(view);\r\n\r\n  if (!appState.raw) {\r\n    renderEmptyState(\"Enter your details to see payment dates.\");\r\n    return;\r\n  }\r\n\r\n  switch (view) {\r\n    case \"calendar\":\r\n      renderCalendarInline();\r\n      break;\r\n    case \"list\":\r\n      renderList();\r\n      break;\r\n    case \"csv\":\r\n      renderCSVInline();\r\n      break;\r\n    case \"ics\":\r\n      renderICSInline();\r\n      break;\r\n  }\r\n}\r\n\r\n\r\n\r\n/* ============================================================\r\n   EXPORTS\r\n============================================================ */\r\n\r\ndocument.getElementById(\"exportBtn\").addEventListener(\"click\", function () {\r\n  \r\n  if (!appState.model) {\r\n    message(\"Nothing to export yet.\");\r\n    return;\r\n  }\r\n  switch (currentView) {\r\n    \r\n    case \"calendar\":\r\n      printCalendar();\r\n      break;\r\n\r\n    case \"list\":\r\n      triggerDownload(\r\n        buildListOutput(appState.model),\r\n        \"text/plain\",\r\n        \"UK-State-Pension-\" + appState.model.meta.ni + \".txt\"\r\n      );\r\n      break;\r\n\r\n    case \"csv\":\r\n      triggerDownload(\r\n        buildCSVOutput(appState.model),\r\n        \"text/csv\",\r\n        \"UK-State-Pension-\" + appState.model.meta.ni + \".csv\"\r\n      );\r\n      break;\r\n\r\n    case \"ics\":\r\n      triggerDownload(\r\n        buildICSOutput(appState.model),\r\n        \"text/calendar\",\r\n        \"UK-State-Pension-\" + appState.model.meta.ni + \".ics\"\r\n      );\r\n      break;\r\n  }\r\n});\r\n\r\nfunction triggerDownload(content, type, name) {\r\n  var b = new Blob([content], { type: type });\r\n  var a = document.createElement(\"a\");\r\n  a.href = URL.createObjectURL(b);\r\n  a.download = name;\r\n  a.click();\r\n}\r\n\r\nfunction buildCSVOutput(model) {\r\n  var csv = \"Payment date,Note\\n\";\r\n\r\n  model.months.forEach(function (m) {\r\n    m.days.forEach(function (d) {\r\n      if (!d.isPayment) return;\r\n      var note = d.paymentFootnoteIndex\r\n        ? m.paymentFootnotes[d.paymentFootnoteIndex - 1]\r\n        : \"\";\r\n      csv += d.iso + ',\"' + note.replace(/\"/g, '\"\"') + '\"\\n';\r\n    });\r\n  });\r\n\r\n  return csv;\r\n}\r\n\r\nfunction buildICSOutput(model) {\r\n  const lines = [];\r\n  const cycleDays = model.meta.cycleDays || 28;\r\n  const title = escapeICS(model.meta.eventTitle || \"UK State Pension\");\r\n  const color = model.meta.eventColor;\r\n  const earlyColor = model.meta.earlyColor || color;\r\n\r\n  \r\n\r\n  lines.push(\"BEGIN:VCALENDAR\");\r\n  lines.push(\"VERSION:2.0\");\r\n  lines.push(\"PRODID:-//UK State Pension Calendar//EN\");\r\n\r\n  const normalDates = [];\r\n  const earlyPayments = [];\r\n\r\n  model.months.forEach(m => {\r\n    m.days.forEach(d => {\r\n      if (!d.isPayment) return;\r\n\r\n      if (d.paymentFootnoteIndex) {\r\n        earlyPayments.push({\r\n          paid: d.iso,\r\n          note: m.paymentFootnotes[d.paymentFootnoteIndex - 1] || \"\"\r\n        });\r\n      } else {\r\n        normalDates.push(d.iso);\r\n      }\r\n    });\r\n  });\r\n\r\n  if (!normalDates.length) {\r\n    lines.push(\"END:VCALENDAR\");\r\n    return lines.join(\"\\n\");\r\n  }\r\n\r\n  /* ---- Recurring event ---- */\r\n\r\n  lines.push(\"BEGIN:VEVENT\");\r\n  lines.push(\"UID:uksp-recurring@\" + location.hostname);\r\n  lines.push(\"DTSTART;VALUE=DATE:\" + normalDates[0].replace(/-/g, \"\"));\r\n  lines.push(\"RRULE:FREQ=DAILY;INTERVAL=\" + cycleDays);\r\n  lines.push(\"SUMMARY:\" + title);\r\n  lines.push(\"CATEGORIES:Pension\");\r\n\r\n  if (color) {\r\n    lines.push(\"X-APPLE-CALENDAR-COLOR:\" + color);\r\n  }\r\n\r\n  earlyPayments.forEach(p => {\r\n    lines.push(\"EXDATE;VALUE=DATE:\" + p.paid.replace(/-/g, \"\"));\r\n  });\r\n\r\n  lines.push(\"END:VEVENT\");\r\n\r\n  /* ---- Early payment overrides ---- */\r\n\r\n  earlyPayments.forEach(p => {\r\n    lines.push(\"BEGIN:VEVENT\");\r\n    lines.push(\r\n      \"UID:uksp-early-\" + p.paid.replace(/-/g, \"\") + \"@\" + location.hostname\r\n    );\r\n    lines.push(\"DTSTART;VALUE=DATE:\" + p.paid.replace(/-/g, \"\"));\r\n    lines.push(\"SUMMARY:\" + title + \" (paid early)\");\r\n    lines.push(\"DESCRIPTION:\" + escapeICS(p.note));\r\n    lines.push(\"CATEGORIES:Pension\");\r\n\r\n    if (earlyColor) {\r\n      lines.push(\"X-APPLE-CALENDAR-COLOR:\" + earlyColor);\r\n    }\r\n\r\n    lines.push(\"END:VEVENT\");\r\n  });\r\n\r\n  lines.push(\"END:VCALENDAR\");\r\n  return lines.join(\"\\n\");\r\n}\r\n\r\n/* ---- ICS text escaping ---- */\r\nfunction escapeICS(text) {\r\n  return String(text || \"\")\r\n    .replace(/\\\\/g, \"\\\\\\\\\")\r\n    .replace(/;/g, \"\\\\;\")\r\n    .replace(/,/g, \"\\\\,\")\r\n    .replace(/\\n/g, \"\\\\n\");\r\n}\r\n\r\n\r\n/* ============================================================\r\n   AUTO PREVIEW ON CHANGE\r\n============================================================ */\r\n[\"startYear\",\"endYear\",\"dateFormat\"].forEach(function (id) {\r\n  var el = document.getElementById(id);\r\n  if (!el) return;\r\n  el.addEventListener(\"change\", function () {\r\n    if (appState.raw) setView(currentView);\r\n  });\r\n});\r\n\r\nsetView(currentView);\r\n</script>"
        }
    ]
}