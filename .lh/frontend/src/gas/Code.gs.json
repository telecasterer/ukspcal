{
    "sourceFile": "frontend/src/gas/Code.gs",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1768898340230,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1768898340230,
            "name": "Commit-0",
            "content": "/*************************************************\r\n * UK STATE PENSION PAYMENT DATES\r\n * Backend â€“ Optimised & Stable\r\n *************************************************/\r\n\r\n/* =================================================\r\n   CONFIG / VERSIONING\r\n================================================= */\r\n\r\nconst VERSION_COMMENT = \"v1.21 short ni code, updated guide and tool tips\";\r\nconst BASE_DATE = new Date(Date.UTC(2025, 11, 29)); // Monday 29 Dec 2025\r\nconst BANK_HOLIDAY_URL = \"https://www.gov.uk/bank-holidays.json\";\r\n\r\n/* =================================================\r\n   HTML TEMPLATE SUPPORT\r\n================================================= */\r\n\r\nfunction include(filename) {\r\n  return HtmlService\r\n    .createHtmlOutputFromFile(filename)\r\n    .getContent();\r\n}\r\n\r\n/* =================================================\r\n   DEPLOYMENT METADATA\r\n================================================= */\r\n\r\nfunction stampDeployment(comment) {\r\n  const props = PropertiesService.getScriptProperties();\r\n  props.setProperties({\r\n    VERSION: Utilities.getUuid().slice(0, 8),\r\n    DEPLOYED_AT: new Date().toISOString(),\r\n    COMMENT: comment || \"No comment\"\r\n  });\r\n}\r\n\r\nfunction deploy_release() {\r\n  stampDeployment(VERSION_COMMENT);\r\n}\r\n\r\nfunction getAppMetadata() {\r\n  const props = PropertiesService.getScriptProperties();\r\n  return {\r\n    version: props.getProperty(\"VERSION\") || \"\",\r\n    deployedAt: props.getProperty(\"DEPLOYED_AT\") || \"\",\r\n    comment: props.getProperty(\"COMMENT\") || \"\"\r\n  };\r\n}\r\n\r\n/* =================================================\r\n   NI PARSING\r\n================================================= */\r\n\r\nfunction parseNI(input) {\r\n  if (!input) {\r\n    throw new Error(\"National Insurance number is required (last 3 characters)\");\r\n  }\r\n\r\n  const cleaned = String(input).toUpperCase().replace(/\\s+/g, \"\");\r\n  const match = cleaned.match(/(\\d{2})([A-D])$/);\r\n\r\n  if (!match) {\r\n    throw new Error(\"NI number must end with two digits and A, B, C or D\");\r\n  }\r\n\r\n  return {\r\n    digits: Number(match[1]),\r\n    letter: match[2],\r\n    ni: match[1] + match[2]\r\n  };\r\n}\r\n\r\n/* =================================================\r\n   BANK HOLIDAYS (CACHED)\r\n================================================= */\r\n\r\nfunction fetchUKBankHolidays() {\r\n  const cache = CacheService.getScriptCache();\r\n  const cached = cache.get(\"UK_BANK_HOLIDAYS\");\r\n  if (cached) {\r\n    return JSON.parse(cached);\r\n  }\r\n\r\n  const response = UrlFetchApp.fetch(BANK_HOLIDAY_URL, {\r\n    muteHttpExceptions: true\r\n  });\r\n\r\n  if (response.getResponseCode() !== 200) {\r\n    throw new Error(\"Failed to fetch UK bank holidays\");\r\n  }\r\n\r\n  const json = JSON.parse(response.getContentText());\r\n  const events = json[\"england-and-wales\"].events;\r\n\r\n  const byYear = {};\r\n\r\n  events.forEach(function (e) {\r\n    const year = Number(e.date.slice(0, 4));\r\n    if (!byYear[year]) byYear[year] = {};\r\n\r\n    let name = e.title;\r\n    if (e.notes && e.notes.toLowerCase().indexOf(\"substitute\") !== -1) {\r\n      name = \"Substitute bank holiday for \" + e.title;\r\n    }\r\n\r\n    byYear[year][e.date] = name;\r\n  });\r\n\r\n  cache.put(\"UK_BANK_HOLIDAYS\", JSON.stringify(byYear), 6 * 60 * 60); // 6 hours\r\n  return byYear;\r\n}\r\n\r\n/* =================================================\r\n   DATE HELPERS\r\n================================================= */\r\n\r\nfunction isWeekendUTC(d) {\r\n  const w = d.getUTCDay();\r\n  return w === 0 || w === 6;\r\n}\r\n\r\n/* =================================================\r\n   PAYMENT GROUP OFFSETS\r\n================================================= */\r\n\r\nfunction rowOffsetFromDigits(d) {\r\n  if (d <= 19) return 0;\r\n  if (d <= 39) return 1;\r\n  if (d <= 59) return 2;\r\n  if (d <= 79) return 3;\r\n  return 4;\r\n}\r\n\r\nfunction columnOffsetFromLetter(l) {\r\n  return { A: 0, B: 1, C: 2, D: 3 }[l];\r\n}\r\n\r\n/* =================================================\r\n   DATE ADJUSTMENT\r\n================================================= */\r\n\r\nfunction adjustForNonWorkingDays(scheduled, holidaysByYear) {\r\n  let paid = new Date(scheduled);\r\n  let early = false;\r\n  let holidayName = null;\r\n\r\n  while (true) {\r\n    const iso = Utilities.formatDate(paid, \"UTC\", \"yyyy-MM-dd\");\r\n    const year = paid.getUTCFullYear();\r\n    const holiday =\r\n      holidaysByYear[year] && holidaysByYear[year][iso];\r\n\r\n    if (holiday) {\r\n      if (!holidayName) holidayName = holiday;\r\n      early = true;\r\n      paid.setUTCDate(paid.getUTCDate() - 1);\r\n      continue;\r\n    }\r\n\r\n    if (isWeekendUTC(paid)) {\r\n      early = true;\r\n      paid.setUTCDate(paid.getUTCDate() - 1);\r\n      continue;\r\n    }\r\n\r\n    break;\r\n  }\r\n\r\n  return {\r\n    paid: Utilities.formatDate(paid, \"UTC\", \"yyyy-MM-dd\"),\r\n    paidDay: Utilities.formatDate(paid, \"UTC\", \"EEEE\"),\r\n    early: early,\r\n    holidays: holidayName ? [holidayName] : []\r\n  };\r\n}\r\n\r\n/* =================================================\r\n   MAIN CALCULATION\r\n================================================= */\r\n\r\nfunction generatePayments(ni, startYear, endYear, cycleDays) {\r\n  cycleDays = Number(cycleDays) || 28;\r\n\r\n  const parsed = parseNI(ni);\r\n  const holidaysByYear = fetchUKBankHolidays();\r\n\r\n  let d = new Date(BASE_DATE);\r\n\r\n  d.setUTCDate(\r\n    d.getUTCDate() +\r\n    rowOffsetFromDigits(parsed.digits) +\r\n    columnOffsetFromLetter(parsed.letter) * 7\r\n  );\r\n\r\n  const normalPaymentDay =\r\n    Utilities.formatDate(d, \"UTC\", \"EEEE\");\r\n\r\n  const payments = [];\r\n\r\n  while (d.getUTCFullYear() < startYear) {\r\n    d.setUTCDate(d.getUTCDate() + cycleDays);\r\n  }\r\n\r\n  while (d.getUTCFullYear() <= endYear) {\r\n    payments.push(adjustForNonWorkingDays(d, holidaysByYear));\r\n    d.setUTCDate(d.getUTCDate() + cycleDays);\r\n  }\r\n\r\n  // Flatten holidays for frontend calendar shading\r\n  const bankHolidays = {};\r\n  Object.keys(holidaysByYear).forEach(function (y) {\r\n    Object.assign(bankHolidays, holidaysByYear[y]);\r\n  });\r\n\r\n  return {\r\n    ni: ni,\r\n    normalDay: normalPaymentDay,\r\n    cycleDays: cycleDays,\r\n    payments: payments,\r\n    bankHolidays: bankHolidays\r\n  };\r\n\r\n}\r\n\r\n/* =================================================\r\n   ENTRY POINT\r\n================================================= */\r\n\r\nfunction doGet() {\r\n  return HtmlService\r\n    .createTemplateFromFile(\"index\")\r\n    .evaluate()\r\n    .setTitle(\"UK State Pension payment dates\")\r\n    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);\r\n}\r\n"
        }
    ]
}