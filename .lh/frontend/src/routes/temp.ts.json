{
    "sourceFile": "frontend/src/routes/temp.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1768757269271,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1768757269271,
            "name": "Commit-0",
            "content": "// src/lib/pensionEngine.ts\r\n\r\nexport type Payment = {\r\n  paid: string;        // YYYY-MM-DD (UTC)\r\n  early: boolean;\r\n  holidays?: string[];\r\n};\r\n\r\nexport type PensionResult = {\r\n  ni: string;\r\n  normalDay: string;\r\n  cycleDays: number;\r\n  payments: Payment[];\r\n};\r\n\r\n/* ------------------------------------------------------------\r\n   VERIFIED DWP ANCHOR\r\n------------------------------------------------------------ */\r\n\r\n// Known real payment:\r\n// NI 29B → Tuesday 6 Jan 2026\r\nconst BASE_DATE = new Date(Date.UTC(2026, 0, 6));\r\nconst BASE_NI = \"29B\";\r\n\r\n/* ------------------------------------------------------------\r\n   DATE HELPERS (UTC SAFE)\r\n------------------------------------------------------------ */\r\n\r\nfunction addDaysUTC(date: Date, days: number): Date {\r\n  const d = new Date(date);\r\n  d.setUTCDate(d.getUTCDate() + days);\r\n  return d;\r\n}\r\n\r\nfunction formatISO(date: Date): string {\r\n  return date.toISOString().slice(0, 10);\r\n}\r\n\r\nfunction isWeekendUTC(d: Date): boolean {\r\n  const day = d.getUTCDay();\r\n  return day === 0 || day === 6;\r\n}\r\n\r\n/* ------------------------------------------------------------\r\n   NI GRID LOGIC (OFFSETS IN WEEKS)\r\n------------------------------------------------------------ */\r\n\r\nfunction parseNI(ni: string): { digits: number; letter: string } {\r\n  const m = ni.toUpperCase().match(/^(\\d{2})([A-D])$/);\r\n  if (!m) throw new Error(`NI parsing failed: ${ni}`);\r\n  return { digits: +m[1], letter: m[2] };\r\n}\r\n\r\nfunction rowFromDigits(d: number): number {\r\n  if (d <= 19) return 0;\r\n  if (d <= 39) return 1;\r\n  if (d <= 59) return 2;\r\n  if (d <= 79) return 3;\r\n  return 4;\r\n}\r\n\r\nfunction niOffsetDays(ni: string): number {\r\n  const base = parseNI(BASE_NI);\r\n  const target = parseNI(ni);\r\n\r\n  const rowOffset =\r\n    (rowFromDigits(target.digits) - rowFromDigits(base.digits)) * 7;\r\n\r\n  const colOffset =\r\n    (target.letter.charCodeAt(0) - base.letter.charCodeAt(0)) * 7;\r\n\r\n  return rowOffset + colOffset;\r\n}\r\n\r\n/* ------------------------------------------------------------\r\n   BANK HOLIDAY ADJUSTMENT (EARLY ONLY)\r\n------------------------------------------------------------ */\r\n\r\nfunction adjustForNonWorkingDays(\r\n  date: Date,\r\n  bankHolidays: Record<string, string>\r\n): { date: Date; early: boolean; holidays: string[] } {\r\n\r\n  let d = new Date(date);\r\n  const reasons: string[] = [];\r\n\r\n  while (true) {\r\n    const iso = formatISO(d);\r\n\r\n    if (isWeekendUTC(d)) {\r\n      reasons.push(\"Weekend\");\r\n      d = addDaysUTC(d, -1);\r\n      continue;\r\n    }\r\n\r\n    if (bankHolidays[iso]) {\r\n      reasons.push(bankHolidays[iso]);\r\n      d = addDaysUTC(d, -1);\r\n      continue;\r\n    }\r\n\r\n    break;\r\n  }\r\n\r\n  return {\r\n    date: d,\r\n    early: d.getTime() !== date.getTime(),\r\n    holidays: reasons\r\n  };\r\n}\r\n\r\n/* ------------------------------------------------------------\r\n   MAIN ENGINE (LOCKED)\r\n------------------------------------------------------------ */\r\n\r\nexport function generatePayments(\r\n  ni: string,\r\n  startYear: number,\r\n  endYear: number,\r\n  cycleDays: number = 28,\r\n  bankHolidays: Record<string, string>\r\n): PensionResult {\r\n\r\n  if (![7, 14, 28].includes(cycleDays)) {\r\n    throw new Error(`Invalid cycleDays: ${cycleDays}`);\r\n  }\r\n\r\n  // 1️⃣ Anchor NI to real DWP grid\r\n  let d = addDaysUTC(BASE_DATE, niOffsetDays(ni));\r\n\r\n  // 2️⃣ Rewind to cover requested range\r\n  while (d.getUTCFullYear() > startYear) {\r\n    d = addDaysUTC(d, -cycleDays);\r\n  }\r\n\r\n  // 3️⃣ Move forward into range\r\n  while (d.getUTCFullYear() < startYear) {\r\n    d = addDaysUTC(d, cycleDays);\r\n  }\r\n\r\n  const payments: Payment[] = [];\r\n\r\n  // 4️⃣ Collect payments\r\n  while (d.getUTCFullYear() <= endYear) {\r\n    const adjusted = adjustForNonWorkingDays(d, bankHolidays);\r\n\r\n    payments.push({\r\n      paid: formatISO(adjusted.date),\r\n      early: adjusted.early,\r\n      holidays: adjusted.holidays.length ? adjusted.holidays : undefined\r\n    });\r\n\r\n    d = addDaysUTC(d, cycleDays);\r\n  }\r\n\r\n  // 5️⃣ Derive weekday name correctly\r\n  const normalDay = addDaysUTC(BASE_DATE, niOffsetDays(ni))\r\n    .toLocaleDateString(\"en-GB\", {\r\n      weekday: \"long\",\r\n      timeZone: \"UTC\"\r\n    });\r\n\r\n  return {\r\n    ni,\r\n    normalDay,\r\n    cycleDays,\r\n    payments\r\n  };\r\n}\r\n"
        }
    ]
}